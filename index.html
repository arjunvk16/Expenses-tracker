<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Manager Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for graphs - UPDATED to a stable, versioned CDN to fix loading error -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons (Removed - no longer needed as icons are inline) -->

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple tab highlighting */
        .tab-btn.active {
            border-bottom-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
            font-weight: 600;
        }
        .tab-btn {
            border-bottom-width: 2px;
            border-bottom-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen antialiased">

    <!-- Global Container -->
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- Header -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-300">
            <h1 class="text-3xl font-bold text-indigo-600">Payment Manager Pro</h1>
            <div id="auth-container" class="flex items-center space-x-2">
                <span id="user-email" class="text-gray-600 text-sm hidden"></span>
                <button id="logout-btn" class="hidden bg-red-500 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-red-600 transition duration-150">
                    Logout
                </button>
            </div>
        </header>

        <!-- Auth Section (Login/Signup) -->
        <section id="auth-section" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-center text-gray-800 mb-6">Welcome</h2>
            <div class="space-y-4">
                <input type="email" id="email-input" placeholder="Email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="password-input" placeholder="Password (min. 6 characters)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <div class="flex space-x-4">
                    <button id="login-btn" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">Login</button>
                    <button id="signup-btn" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-gray-700 transition duration-150">Sign Up</button>
                </div>
                <p id="auth-error" class="text-red-500 text-sm text-center"></p>
            </div>
        </section>

        <!-- Main App Content (Hidden until logged in) -->
        <main id="app-content" class="hidden">

            <!-- Tab Navigation -->
            <nav class="mb-6 bg-white rounded-lg shadow-sm">
                <div class="flex border-b border-gray-200">
                    <button data-tab="dashboard" class="tab-btn active px-6 py-3 text-gray-600 hover:text-indigo-600">Dashboard</button>
                    <button data-tab="payments" class="tab-btn px-6 py-3 text-gray-600 hover:text-indigo-600">Payments</button>
                    <button data-tab="people" class="tab-btn px-6 py-3 text-gray-600 hover:text-indigo-600">Manage People</button>
                </div>
            </nav>

            <!-- Tab Content -->
            <div>
                <!-- Dashboard Tab -->
                <div id="tab-dashboard" class="tab-content grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Spending by Person</h3>
                        <canvas id="persons-chart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Monthly Report</h3>
                        <select id="monthly-report-year" class="mb-4 w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <!-- Years will be populated by JS -->
                        </select>
                        <canvas id="monthly-chart"></canvas>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-lg lg:col-span-2">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Total Spending</h3>
                        <p class="text-4xl font-bold text-indigo-600" id="total-spending">...</p>
                    </div>
                </div>

                <!-- Payments Tab -->
                <div id="tab-payments" class="tab-content hidden space-y-6">
                    <!-- Add/Edit Payment Form -->
                    <form id="payment-form" class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 id="form-title" class="text-xl font-semibold mb-4 text-gray-800">Add New Payment</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="payment-date" class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" id="payment-date" required class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="payment-name" class="block text-sm font-medium text-gray-700">Name</label>
                                <select id="payment-name" required class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Select a person</option>
                                    <!-- Names populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="payment-amount" class="block text-sm font-medium text-gray-700">Amount ($)</label>
                                <input type="number" id="payment-amount" step="0.01" min="0" required class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="0.00">
                            </div>
                        </div>
                        <div class="mt-6 flex space-x-4">
                            <button type="submit" id="submit-payment-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">Add Payment</button>
                            <button type="button" id="cancel-edit-btn" class="hidden bg-gray-500 text-white px-6 py-2 rounded-lg shadow-md hover:bg-gray-600 transition duration-150">Cancel Edit</button>
                        </div>
                        <input type="hidden" id="payment-id-hidden">
                    </form>

                    <!-- Payments List -->
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">All Payments</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="payments-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows populated by JS -->
                                    <tr>
                                        <td colspan="4" class="px-6 py-4 text-center text-gray-500" id="no-payments-msg">No payments found.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Manage People Tab -->
                <div id="tab-people" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Add Person Form -->
                    <form id="person-form" class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 id="person-form-title" class="text-xl font-semibold mb-4 text-gray-800">Add New Person</h3>
                        <div class="flex space-x-4">
                            <input type="text" id="person-name" placeholder="Enter new name" required class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button type="submit" id="submit-person-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-green-700 transition duration-150">Add</button>
                        </div>
                        <div class="mt-4">
                             <button type="button" id="cancel-person-edit-btn" class="hidden w-full bg-gray-500 text-white px-6 py-2 rounded-lg shadow-md hover:bg-gray-600 transition duration-150">Cancel Edit</button>
                        </div>
                        <input type="hidden" id="person-id-hidden">
                        <input type="hidden" id="person-old-name-hidden">
                    </form>

                    <!-- People List -->
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Saved People</h3>
                        <ul id="people-list" class="space-y-3 max-h-60 overflow-y-auto">
                            <!-- People populated by JS -->
                            <li id="no-people-msg" class="text-gray-500">No people saved yet.</li>
                        </ul>
                    </div>
                </div>
            </div>

        </main>
        
        <!-- Global Message/Toast -->
        <div id="toast-message" class="hidden fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-xl transition-all duration-300 ease-out">
            <span id="toast-text"></span>
        </div>

    </div> <!-- End Global Container -->


    <!-- Firebase SDKs -->
    <script type="module">
        // Firebase 11 imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            signInAnonymously,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            collection, 
            addDoc, 
            getDocs, 
            onSnapshot, 
            updateDoc, 
            deleteDoc, 
            query, 
            where, 
            setDoc, 
            serverTimestamp,
            writeBatch,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- MANDATORY GLOBAL VARS ---
        // These are provided by the environment. DO NOT change them.
        
        // --- MODIFICATION ---
        // The __firebase_config from the environment is being IGNORED per your request.
        // We are now hard-coding your config for 'my-chain-reaction-game'.
        // This will allow you to log in, but breaks the intended environment integration.
        const firebaseConfig = {
            apiKey: "AIzaSyAJ9K9fQ0ThMB7aXB6qNHr3_yLUdqJgnCM",
            authDomain: "my-chain-reaction-game.firebaseapp.com",
            projectId: "my-chain-reaction-game",
            storageBucket: "my-chain-reaction-game.appspot.com",
            messagingSenderId: "32751418407",
            appId: "1:32751418407:web:ff8244007ef2b099d56202"
        };
        // const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        // The appId is now irrelevant as we are not using the environment's project.
        // Using a default value.
        // const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-chain-reaction-game';
        
        // --- CRITICAL FIX ---
        // We MUST hard-code the appId to match the hard-coded firebaseConfig.
        // This ensures the database paths (e.g., /artifacts/my-chain-reaction-game/...)
        // are correct for the project we are connected to.
        const appId = 'my-chain-reaction-game';
        // --- END FIX ---
        
        // The initialAuthToken is also irrelevant as it's for the environment's project.
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --- END MODIFICATION ---

        // Firebase App Initialization
        let app, auth, db;
        let userId = null;
        let personsUnsubscribe = null;
        let paymentsUnsubscribe = null;

        let peopleCache = []; // Local cache for people
        let paymentsCache = []; // Local cache for payments

        // Chart instances
        let personsChartInstance = null;
        let monthlyChartInstance = null;

        // DOM Elements
        const authSection = document.getElementById('auth-section');
        const appContent = document.getElementById('app-content');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const authError = document.getElementById('auth-error');
        const userEmail = document.getElementById('user-email');

        const paymentForm = document.getElementById('payment-form');
        const paymentDate = document.getElementById('payment-date');
        const paymentNameSelect = document.getElementById('payment-name');
        const paymentAmount = document.getElementById('payment-amount');
        const paymentIdHidden = document.getElementById('payment-id-hidden');
        const formTitle = document.getElementById('form-title');
        const submitPaymentBtn = document.getElementById('submit-payment-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const paymentsTableBody = document.getElementById('payments-table-body');
        const noPaymentsMsg = document.getElementById('no-payments-msg');

        const personForm = document.getElementById('person-form');
        const personNameInput = document.getElementById('person-name');
        const peopleList = document.getElementById('people-list');
        const noPeopleMsg = document.getElementById('no-people-msg');
        const personFormTitle = document.getElementById('person-form-title');
        const submitPersonBtn = document.getElementById('submit-person-btn');
        const cancelPersonEditBtn = document.getElementById('cancel-person-edit-btn');
        const personIdHidden = document.getElementById('person-id-hidden');
        const personOldNameHidden = document.getElementById('person-old-name-hidden');

        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        const personsChartCanvas = document.getElementById('persons-chart');
        const monthlyChartCanvas = document.getElementById('monthly-chart');
        const monthlyReportYearSelect = document.getElementById('monthly-report-year');
        const totalSpendingEl = document.getElementById('total-spending');
        
        const toast = document.getElementById('toast-message');
        const toastText = document.getElementById('toast-text');

        // --- Utility Functions ---
        
        /**
         * Shows a toast message.
         * @param {string} message - The text to display.
         * @param {boolean} [isError=false] - If true, shows a red error toast.
         */
        function showToast(message, isError = false) {
            toastText.textContent = message;
            toast.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
            
            if (isError) {
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.add('bg-green-500');
            }
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        /**
         * Formats a number as currency.
         * @param {number} amount - The number to format.
         * @returns {string} - Formatted currency string (e.g., $1,234.50).
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
            }).format(amount);
        }

        // --- Firebase Initialization & Auth ---
        
        /**
         * Initializes Firebase and sets up authentication.
         */
        async function initializeFirebase() {
            try {
                // --- ADDED GUARD CLAUSE ---
                // Check if the mandatory config is missing or empty.
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Fatal Error: Firebase config is missing or empty.");
                    authError.textContent = "Fatal Error: App configuration is missing. Cannot load.";
                    authError.classList.remove('hidden'); // Ensure the error is visible
                    return; // Stop all further execution
                }
                // --- END GUARD CLAUSE ---

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // Added for better debugging

                // Set up auth state listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        userEmail.textContent = user.email || 'Logged In';
                        userEmail.classList.remove('hidden');
                        logoutBtn.classList.remove('hidden');
                        authSection.classList.add('hidden');
                        appContent.classList.remove('hidden');

                        // Attach Firestore listeners for this user
                        attachFirestoreListeners(userId);
                        // Set default date for payment form
                        paymentDate.valueAsDate = new Date();
                        
                    } else {
                        // User is signed out
                        userId = null;
                        userEmail.classList.add('hidden');
                        logoutBtn.classList.add('hidden');
                        authSection.classList.remove('hidden');
                        appContent.classList.add('hidden');

                        // Detach listeners
                        detachFirestoreListeners();
                        // Clear UI
                        clearUI();
                    }
                });

                // Sign in the user
                if (initialAuthToken) {
                    // This will likely fail now as the token is for a different project,
                    // but we will fall back to manual login.
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (tokenError) {
                        console.warn("Initial token sign-in failed (expected, as projects differ). Please log in manually.");
                        if (auth.currentUser === null) {
                             console.log("No initial token. User must log in or sign up.");
                        }
                    }
                } else if (auth.currentUser === null) {
                    // Fallback for environments without a custom token (e.g., local testing)
                    // In a real-world scenario, you'd only show login/signup.
                    // For this app, we'll keep the auth wall up.
                    console.log("No initial token. User must log in or sign up.");
                }

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                authError.textContent = "Failed to initialize app. Please refresh.";
            }
        }

        /**
         * Handles user signup.
         */
        async function handleSignup() {
            const email = emailInput.value;
            const password = passwordInput.value;
            authError.textContent = '';

            if (password.length < 6) {
                authError.textContent = 'Password must be at least 6 characters long.';
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle the rest
                showToast("Account created successfully!");
            } catch (error) {
                console.error("Signup error:", error.message);
                authError.textContent = `Signup failed: ${error.message}`;
            }
        }

        /**
         * Handles user login.
         */
        async function handleLogin() {
            const email = emailInput.value;
            const password = passwordInput.value;
            authError.textContent = '';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Login error:", error.message);
                authError.textContent = `Login failed: ${error.message}`;
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Logout error:", error.message);
                showToast("Logout failed. Please try again.", true);
            }
        }
        
        /**
         * Clears all dynamic UI elements.
         */
        function clearUI() {
            peopleCache = [];
            paymentsCache = [];
            paymentsTableBody.innerHTML = '';
            peopleList.innerHTML = '';
            paymentNameSelect.innerHTML = '<option value="">Select a person</option>';
            // Destroy charts if they exist
            if (personsChartInstance) personsChartInstance.destroy();
            if (monthlyChartInstance) monthlyChartInstance.destroy();
            personsChartInstance = null;
            monthlyChartInstance = null;
        }

        // --- Firestore Listeners ---

        /**
         * Attaches real-time listeners for persons and payments.
         * @param {string} uid - The current user's ID.
         */
        function attachFirestoreListeners(uid) {
            if (!db || !uid) return;

            // Detach any existing listeners first
            detachFirestoreListeners();

            // --- Persons Listener ---
            const personsPath = `/artifacts/${appId}/users/${uid}/persons`;
            const personsRef = collection(db, personsPath);
            // Note: Not using orderBy as per instructions, will sort in JS.
            personsUnsubscribe = onSnapshot(personsRef, (snapshot) => {
                peopleCache = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => a.name.localeCompare(b.name)); // Sort in memory
                
                renderPeopleList(peopleCache);
                renderPeopleDropdown(peopleCache);
                updateCharts(); // Update charts as people might be deleted
                
            }, (error) => {
                console.error("Error listening to persons collection:", error);
                showToast("Could not load people.", true);
            });

            // --- Payments Listener ---
            const paymentsPath = `/artifacts/${appId}/users/${uid}/payments`;
            const paymentsRef = collection(db, paymentsPath);
            // Note: Not using orderBy as per instructions, will sort in JS.
            paymentsUnsubscribe = onSnapshot(paymentsRef, (snapshot) => {
                paymentsCache = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending
                
                renderPaymentsTable(paymentsCache);
                updateCharts();
                
            }, (error) => {
                console.error("Error listening to payments collection:", error);
                showToast("Could not load payments.", true);
            });
        }

        /**
         * Detaches all active Firestore listeners.
         */
        function detachFirestoreListeners() {
            if (personsUnsubscribe) {
                personsUnsubscribe();
                personsUnsubscribe = null;
            }
            if (paymentsUnsubscribe) {
                paymentsUnsubscribe();
                paymentsUnsubscribe = null;
            }
        }

        // --- UI Rendering ---

        /**
         * Renders the list of saved people in the "Manage People" tab.
         * @param {Array} people - Array of person objects.
         */
        function renderPeopleList(people) {
            peopleList.innerHTML = ''; // Clear list
            if (people.length === 0) {
                peopleList.appendChild(noPeopleMsg);
                noPeopleMsg.classList.remove('hidden');
                return;
            }
            
            noPeopleMsg.classList.add('hidden');

            people.forEach(person => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                li.innerHTML = `
                    <span class="text-gray-800">${person.name}</span>
                    <div class="flex space-x-2">
                        <button data-id="${person.id}" data-name="${person.name}" class="edit-person-btn text-indigo-600 hover:text-indigo-900">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                        <button data-id="${person.id}" data-name="${person.name}" class="delete-person-btn text-red-500 hover:text-red-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                peopleList.appendChild(li);
            });
        }

        /**
         * Populates the <select> dropdown in the payments form.
         * @param {Array} people - Array of person objects.
         */
        function renderPeopleDropdown(people) {
            paymentNameSelect.innerHTML = '<option value="">Select a person</option>'; // Clear and add placeholder
            people.forEach(person => {
                const option = document.createElement('option');
                option.value = person.name; // Use name as value
                option.textContent = person.name;
                paymentNameSelect.appendChild(option);
            });
        }

        /**
         * Renders the payments table in the "Payments" tab.
         * @param {Array} payments - Array of payment objects.
         */
        function renderPaymentsTable(payments) {
            paymentsTableBody.innerHTML = ''; // Clear table
            if (payments.length === 0) {
                paymentsTableBody.appendChild(noPaymentsMsg);
                noPaymentsMsg.classList.remove('hidden');
                return;
            }
            
            noPaymentsMsg.classList.add('hidden');

            payments.forEach(payment => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${payment.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${payment.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${formatCurrency(payment.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right space-x-2">
                        <button data-id="${payment.id}" class="edit-payment-btn text-indigo-600 hover:text-indigo-900">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                        <button data-id="${payment.id}" class="delete-payment-btn text-red-500 hover:text-red-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                paymentsTableBody.appendChild(tr);
            });
        }

        // --- Chart/Dashboard Logic ---

        /**
         * Main function to update all charts and dashboard stats.
         */
        function updateCharts() {
            if (!paymentsCache || !peopleCache) return;

            // 1. Update Total Spending
            const total = paymentsCache.reduce((sum, p) => sum + p.amount, 0);
            totalSpendingEl.textContent = formatCurrency(total);

            // 2. Update Persons Chart
            const spendingByPerson = paymentsCache.reduce((acc, payment) => {
                acc[payment.name] = (acc[payment.name] || 0) + payment.amount;
                return acc;
            }, {});

            // Filter out people who are in the list but have 0 spending
            const personLabels = Object.keys(spendingByPerson);
            const personData = Object.values(spendingByPerson);
            
            renderPersonsChart(personLabels, personData);

            // 3. Update Monthly Chart
            // First, populate year dropdown
            populateYearFilter();
            // Then, render the chart for the selected year
            renderMonthlyChart();
        }

        /**
         * Populates the year filter dropdown based on available payment data.
         */
        function populateYearFilter() {
            const years = new Set(paymentsCache.map(p => new Date(p.date).getFullYear()));
            if (years.size === 0) {
                // Add current year if no data
                years.add(new Date().getFullYear());
            }
            
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            const currentYearSelection = monthlyReportYearSelect.value;
            
            monthlyReportYearSelect.innerHTML = '';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                monthlyReportYearSelect.appendChild(option);
            });
            
            // Try to keep the current selection
            if (sortedYears.includes(parseInt(currentYearSelection))) {
                monthlyReportYearSelect.value = currentYearSelection;
            } else if (sortedYears.length > 0) {
                monthlyReportYearSelect.value = sortedYears[0];
            }
        }
        
        /**
         * Renders the bar chart for spending by person.
         * @param {Array} labels - Array of person names.
         * @param {Array} data - Array of total amounts.
         */
        function renderPersonsChart(labels, data) {
            if (personsChartInstance) {
                personsChartInstance.destroy();
            }
            personsChartInstance = new Chart(personsChartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Spending',
                        data: data,
                        backgroundColor: 'rgba(79, 70, 229, 0.8)', // indigo-600
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => formatCurrency(value)
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.raw)
                            }
                        }
                    }
                }
            });
        }

        /**
         * Renders the line chart for monthly spending, filtered by the selected year.
         */
        function renderMonthlyChart() {
            const selectedYear = parseInt(monthlyReportYearSelect.value);
            if (isNaN(selectedYear)) return; // No year selected or no data

            const monthlyTotals = new Array(12).fill(0); // 0 = Jan, 11 = Dec

            const filteredPayments = paymentsCache.filter(p => new Date(p.date).getFullYear() === selectedYear);

            filteredPayments.forEach(payment => {
                const monthIndex = new Date(payment.date).getMonth(); // 0-11
                monthlyTotals[monthIndex] += payment.amount;
            });

            const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            if (monthlyChartInstance) {
                monthlyChartInstance.destroy();
            }
            monthlyChartInstance = new Chart(monthlyChartCanvas, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: `Monthly Spending for ${selectedYear}`,
                        data: monthlyTotals,
                        fill: false,
                        borderColor: 'rgb(22, 163, 74)', // green-600
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => formatCurrency(value)
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.raw)
                            }
                        }
                    }
                }
            });
        }

        // --- Firestore CRUD Operations ---

        /**
         * Handles the submission of the "Add Person" form.
         * @param {Event} e - The form submit event.
         */
        async function handleSubmitPerson(e) {
            e.preventDefault();
            const newName = personNameInput.value.trim();
            if (!newName) return;

            const personId = personIdHidden.value;
            const oldName = personOldNameHidden.value;
            
            // Check for duplicates (case-insensitive)
            const existingPerson = peopleCache.find(p => p.name.toLowerCase() === newName.toLowerCase());
            
            // If in edit mode, allow saving if the name is unchanged or if it's a new name
            if (personId) {
                // In edit mode
                if (existingPerson && existingPerson.id !== personId) {
                     showToast("This name is already used by another person.", true);
                     return;
                }
                
                // --- This is a complex atomic update ---
                // We must update the person doc AND all payment docs that used the old name
                try {
                    const batch = writeBatch(db);
                    
                    // 1. Update the person document
                    const personDocPath = `/artifacts/${appId}/users/${userId}/persons/${personId}`;
                    batch.update(doc(db, personDocPath), { name: newName });
                    
                    // 2. Find and update all associated payments
                    const paymentsPath = `/artifacts/${appId}/users/${userId}/payments`;
                    const paymentsQuery = query(collection(db, paymentsPath), where("name", "==", oldName));
                    
                    const querySnapshot = await getDocs(paymentsQuery);
                    querySnapshot.forEach((paymentDoc) => {
                        // Update the 'name' field on each payment
                        batch.update(paymentDoc.ref, { name: newName });
                    });
                    
                    // 3. Commit the batch
                    await batch.commit();
                    
                    showToast("Person and all associated payments updated!");
                    resetPersonForm();
                    
                } catch (error) {
                    console.error("Error updating person and payments:", error);
                    showToast("Failed to update person.", true);
                }
                
            } else {
                // In add mode
                if (existingPerson) {
                    showToast("This person already exists.", true);
                    return;
                }

                try {
                    const personsPath = `/artifacts/${appId}/users/${userId}/persons`;
                    const personsRef = collection(db, personsPath);
                    await addDoc(personsRef, {
                        name: newName,
                        createdAt: serverTimestamp()
                    });
                    
                    personNameInput.value = '';
                    showToast("Person added successfully!");
                    
                } catch (error) {
                    console.error("Error adding person:", error);
                    showToast("Failed to add person.", true);
                }
            }
        }

        /**
         * Populates the person form for editing.
         * @param {string} personId - The Firestore document ID of the person.
         * @param {string} personName - The current name of the person.
         */
        function handleEditPerson(personId, personName) {
            personNameInput.value = personName;
            personIdHidden.value = personId;
            personOldNameHidden.value = personName;
            
            personFormTitle.textContent = "Edit Person's Name";
            submitPersonBtn.textContent = "Update Name";
            cancelPersonEditBtn.classList.remove('hidden');
            
            personForm.scrollIntoView({ behavior: 'smooth' });
            personNameInput.focus();
        }

        /**
         * Resets the person form to its default (add) state.
         */
        function resetPersonForm() {
            personForm.reset();
            personIdHidden.value = '';
            personOldNameHidden.value = '';
            personFormTitle.textContent = 'Add New Person';
            submitPersonBtn.textContent = 'Add';
            cancelPersonEditBtn.classList.add('hidden');
        }

        /**
         * Handles deleting a person.
         * @param {string} personId - The Firestore document ID of the person.
         * @param {string} personName - The name of the person (for checking payments).
         */
        async function handleDeletePerson(personId, personName) {
            // Check if this person is used in any payments
            if (paymentsCache.some(p => p.name === personName)) {
                // This is a design choice. We could allow it, but it might orphan data.
                // For this app, we'll prevent deletion if they are tied to payments.
                // A better app might ask to re-assign payments.
                showToast("Cannot delete person. They are associated with existing payments.", true);
                return;
            }

            // Simple confirmation dialog (replaces window.confirm)
            // Removed blocking confirm() call as it's not supported here.
            
            try {
                const personPath = `/artifacts/${appId}/users/${userId}/persons/${personId}`;
                await deleteDoc(doc(db, personPath));
                
                showToast("Person deleted successfully.");
                
            } catch (error) {
                console.error("Error deleting person:", error);
                showToast("Failed to delete person.", true);
            }
        }

        /**
         * Resets the payment form to its default (add) state.
         */
        function resetPaymentForm() {
            paymentForm.reset();
            paymentDate.valueAsDate = new Date();
            paymentIdHidden.value = '';
            formTitle.textContent = 'Add New Payment';
            submitPaymentBtn.textContent = 'Add Payment';
            cancelEditBtn.classList.add('hidden');
        }

        /**
         * Handles the submission of the payment form (both add and update).
         * @param {Event} e - The form submit event.
         */
        async function handleSubmitPayment(e) {
            e.preventDefault();
            
            const paymentData = {
                date: paymentDate.value,
                name: paymentNameSelect.value,
                amount: parseFloat(paymentAmount.value)
            };
            
            if (!paymentData.date || !paymentData.name || isNaN(paymentData.amount) || paymentData.amount <= 0) {
                showToast("Please fill in all fields with valid data.", true);
                return;
            }
            
            const paymentId = paymentIdHidden.value;
            
            try {
                if (paymentId) {
                    // --- Update existing payment ---
                    const paymentPath = `/artifacts/${appId}/users/${userId}/payments/${paymentId}`;
                    await updateDoc(doc(db, paymentPath), paymentData);
                    showToast("Payment updated successfully!");
                } else {
                    // --- Add new payment ---
                    const paymentsPath = `/artifacts/${appId}/users/${userId}/payments`;
                    await addDoc(collection(db, paymentsPath), {
                        ...paymentData,
                        createdAt: serverTimestamp()
                    });
                    showToast("Payment added successfully!");
                }
                resetPaymentForm();
                
            } catch (error) {
                console.error("Error saving payment:", error);
                showToast("Failed to save payment.", true);
            }
        }

        /**
         * Populates the payment form for editing.
         * @param {string} paymentId - The Firestore document ID of the payment.
         */
        function handleEditPayment(paymentId) {
            // Find the payment in our local cache
            const payment = paymentsCache.find(p => p.id === paymentId);
            if (!payment) {
                showToast("Could not find payment to edit.", true);
                return;
            }
            
            // Populate the form
            paymentDate.value = payment.date;
            paymentNameSelect.value = payment.name;
            paymentAmount.value = payment.amount;
            paymentIdHidden.value = paymentId;
            
            // Update UI to "edit mode"
            formTitle.textContent = "Edit Payment";
            submitPaymentBtn.textContent = "Update Payment";
            cancelEditBtn.classList.remove('hidden');
            
            // Scroll to the form
            paymentForm.scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * Handles deleting a payment.
         * @param {string} paymentId - The Firestore document ID of the payment.
        async function handleDeletePayment(paymentId) {
            // Removed blocking confirm() call as it's not supported here.
            
            try {
                const paymentPath = `/artifacts/${appId}/users/${userId}/payments/${paymentId}`;
                await deleteDoc(doc(db, paymentPath));
                showToast("Payment deleted.");
                resetPaymentForm(); // In case we were editing this one
                
            } catch (error) {
                console.error("Error deleting payment:", error);
                showToast("Failed to delete payment.", true);
            }
        }
        
        // --- Event Listeners ---

        /**
         * Handles tab switching.
         * @param {Event} e - The click event.
         */
        function handleTabClick(e) {
            const clickedTab = e.currentTarget.dataset.tab;

            // Update button styles
            tabButtons.forEach(btn => {
                if (btn.dataset.tab === clickedTab) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Show/hide content
            tabContents.forEach(content => {
                if (content.id === `tab-${clickedTab}`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
            
            // Re-render charts if switching to dashboard, as canvas might have been hidden
            if(clickedTab === 'dashboard') {
                updateCharts();
            }
        }

        // --- Auth Listeners ---
        loginBtn.addEventListener('click', handleLogin);
        signupBtn.addEventListener('click', handleSignup);
        logoutBtn.addEventListener('click', handleLogout);

        // --- Tab Listeners ---
        tabButtons.forEach(btn => btn.addEventListener('click', handleTabClick));

        // --- Form Listeners ---
        personForm.addEventListener('submit', handleSubmitPerson);
        cancelPersonEditBtn.addEventListener('click', resetPersonForm);
        paymentForm.addEventListener('submit', handleSubmitPayment);
        cancelEditBtn.addEventListener('click', resetPaymentForm);
        monthlyReportYearSelect.addEventListener('change', renderMonthlyChart);

        // --- Dynamic Content Listeners (Event Delegation) ---
        
        // Listener for "Manage People" list
        peopleList.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-person-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                const name = deleteBtn.dataset.name;
                handleDeletePerson(id, name);
                return; // Prevent edit from firing
            }
            
            const editBtn = e.target.closest('.edit-person-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                const name = editBtn.dataset.name;
                handleEditPerson(id, name);
            }
        });
        
        // Listener for "Payments" table
        paymentsTableBody.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-payment-btn');
            if (deleteBtn) {
                handleDeletePayment(deleteBtn.dataset.id);
                return; // Prevent edit from firing
            }
            
            const editBtn = e.target.closest('.edit-payment-btn');
            if (editBtn) {
                handleEditPayment(editBtn.dataset.id);
            }
        });

        // --- Icons ---
        // Icons are now inline SVGs, no JS needed.
        window.onload = () => {
            // Initialize Firebase App FIRST
            initializeFirebase();
            
            // Icon loading removed - no longer necessary.
        };

    </script>
</body>
</html>

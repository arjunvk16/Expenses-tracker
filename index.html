<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Manager Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
            color: #e5e7eb; /* gray-200 */
        }
        /* Simple tab highlighting */
        .tab-btn.active {
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            font-weight: 600;
        }
        /* Filter button highlighting */
        .filter-btn.active {
            background-color: #3b82f6; /* blue-500 */
            color: #ffffff;
        }
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        /* Dark mode for input[type=date] */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed top-5 right-5 z-50 p-4 rounded-lg shadow-lg max-w-sm text-white">
        <!-- Message will be injected here -->
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- Header -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-700">
            <h1 class="text-2xl sm:text-3xl font-bold text-blue-400">Payment Manager Pro</h1>
            <div id="auth-container" class="flex items-center space-x-2">
                <span id="user-email" class="text-gray-400 text-sm hidden"></span>
                <button id="logout-btn" class="hidden bg-red-600 text-white px-3 py-1 rounded-lg text-sm shadow-md hover:bg-red-700 transition duration-150">Logout</button>
            </div>
        </header>

        <!-- Auth Section -->
        <section id="auth-section" class="max-w-md mx-auto bg-gray-800 p-8 rounded-lg shadow-lg">
            <h2 class="text-xl sm:text-2xl font-semibold text-center text-gray-100 mb-6">Welcome</h2>
            <div class="space-y-4">
                <input type="email" id="email-input" placeholder="Email" class="w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400">
                <input type="password" id="password-input" placeholder="Password (min. 6 characters)" class="w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400">
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                    <button id="login-btn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition duration-150">Login</button>
                    <button id="signup-btn" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-gray-700 transition duration-150">Sign Up</button>
                </div>
                <p id="auth-error" class="text-red-400 text-sm text-center"></p>
                <p id="auth-loading" class="text-blue-400 text-sm text-center hidden">Connecting...</p>
                <p id="config-error" class="text-yellow-400 text-sm text-center hidden"></p>
            </div>
        </section>

        <!-- Main App Section (hidden by default) -->
        <main id="app-section" class="hidden">
            <!-- Tab Navigation -->
            <nav class="mb-6 bg-gray-800 rounded-lg shadow-sm">
                <div class="flex border-b border-gray-700 overflow-x-auto whitespace-nowrap">
                    <button data-tab="dashboard" class="tab-btn active px-4 sm:px-6 py-3 text-sm sm:text-base text-gray-400 hover:text-blue-400">Dashboard</button>
                    <button data-tab="payments" class="tab-btn px-4 sm:px-6 py-3 text-sm sm:text-base text-gray-400 hover:text-blue-400">Payments</button>
                    <button data-tab="people" class="tab-btn px-4 sm:px-6 py-3 text-sm sm:text-base text-gray-400 hover:text-blue-400">Manage People</button>
                    <button data-tab="categories" class="tab-btn px-4 sm:px-6 py-3 text-sm sm:text-base text-gray-400 hover:text-blue-400">Manage Categories</button>
                </div>
            </nav>

            <!-- Tab Content -->
            <div>
                <!-- Dashboard Tab -->
                <section id="dashboard-tab" class="tab-content space-y-6">
                    <!-- Dashboard Filters -->
                    <div class="flex flex-wrap justify-start sm:justify-center gap-2 bg-gray-800 p-2 rounded-lg">
                        <button data-filter="month" class="filter-btn px-4 py-2 text-sm font-medium rounded-md text-gray-300 hover:bg-gray-700">This Month</button>
                        <button data-filter="year" class="filter-btn px-4 py-2 text-sm font-medium rounded-md text-gray-300 hover:bg-gray-700">This Year</button>
                        <button data-filter="all" class="filter-btn active px-4 py-2 text-sm font-medium rounded-md text-gray-300 hover:bg-gray-700">All Time</button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Total Spending -->
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg lg:col-span-1">
                            <h3 class="text-xl font-semibold mb-4 text-gray-100">Total Spending</h3>
                            <p class="text-4xl font-bold text-blue-400" id="total-spending">...</p>
                            <!-- UPDATED: SECTION FOR TOP 5 SPENDERS -->
                            <div id="top-spenders" class="mt-4 pt-4 border-t border-gray-700 space-y-2">
                                <!-- Content will be injected by JS -->
                            </div>
                        </div>
                        
                        <!-- Spending by Person -->
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg lg:col-span-2">
                            <h3 class="text-xl font-semibold mb-4 text-gray-100">Spending by Person</h3>
                            <div class="relative h-80">
                                <canvas id="persons-chart"></canvas>
                            </div>
                        </div>

                        <!-- Spending by Category -->
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg lg:col-span-2">
                            <h3 class="text-xl font-semibold mb-4 text-gray-100">Spending by Category</h3>
                            <div class="relative h-80">
                                <canvas id="categories-chart"></canvas>
                            </div>
                            <p id="no-category-data-msg" class="text-center text-gray-400 hidden">No category data for this period.</p>
                        </div>

                        <!-- Monthly Report -->
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg lg:col-span-3">
                            <h3 class="text-xl font-semibold mb-4 text-gray-100">Total Monthly Report</h3>
                            <select id="monthly-report-year" class="mb-4 w-full md:w-auto px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white">
                                <!-- Years will be populated by JS -->
                            </select>
                            <div class="relative h-96">
                                <canvas id="monthly-chart"></canvas>
                            </div>
                        </div>

                        <!-- UPDATED: User Payment Report -->
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg lg:col-span-3">
                            <h3 class="text-xl font-semibold mb-4 text-gray-100">User Payment Report</h3>
                            <div class="flex flex-col md:flex-row gap-4 mb-4">
                                <select id="user-report-person-select" class="flex-1 px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white">
                                    <option value="">-- Select a Person --</option>
                                    <!-- People populated by JS -->
                                </select>
                                <select id="user-report-period-select" class="flex-1 md:w-auto px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white">
                                    <!-- Periods populated by JS -->
                                </select>
                            </div>
                            <div class="relative h-96">
                                <canvas id="user-monthly-chart"></canvas>
                                <p id="user-report-no-data-msg" class="text-center text-gray-400 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 hidden">No data for this user in the selected year.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Payments Tab -->
                <section id="payments-tab" class="tab-content hidden space-y-6">
                    
                    <!-- Payment Templates (NEW) -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-100 mb-4">Payment Templates</h3>
                        <div id="template-buttons" class="flex flex-wrap gap-2">
                            <!-- Template buttons populated by JS -->
                        </div>
                        <p id="no-templates-msg" class="text-gray-400 text-sm hidden">No templates saved. Add a payment and check "Save as Template" to create one.</p>
                    </div>

                    <!-- Add/Edit Payment Form -->
                    <form id="payment-form" class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 id="form-title" class="text-xl font-semibold mb-4 text-gray-100">Add New Payment</h3>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <label for="payment-date" class="block text-sm font-medium text-gray-300">Date</label>
                                <input type="date" id="payment-date" required class="mt-1 w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400">
                            </div>
                            <div>
                                <label for="payment-name-input" class="block text-sm font-medium text-gray-300">Name</label>
                                <input list="payment-name-list" id="payment-name-input" required class="mt-1 w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white" placeholder="Type or select name...">
                                <datalist id="payment-name-list">
                                    <!-- Names populated by JS -->
                                </datalist>
                            </div>
                            <div>
                                <label for="payment-category-input" class="block text-sm font-medium text-gray-300">Category</label>
                                <input list="payment-category-list" id="payment-category-input" required class="mt-1 w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white" placeholder="Type or select category...">
                                <datalist id="payment-category-list">
                                    <!-- Categories populated by JS -->
                                </datalist>
                            </div>
                            <div>
                                <label for="payment-amount" class="block text-sm font-medium text-gray-300">Amount (â‚¹)</label>
                                <input type="number" id="payment-amount" step="0.01" min="0" required class="mt-1 w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400" placeholder="0.00">
                            </div>
                            <!-- NEW Notes Field -->
                            <div class="md:col-span-1">
                                <label for="payment-notes" class="block text-sm font-medium text-gray-300">Notes</label>
                                <input type="text" id="payment-notes" class="mt-1 w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400" placeholder="e.g., Morning auto">
                            </div>
                        </div>

                        <!-- Template Options (NEW) -->
                        <div class="mt-6 space-y-4">
                            <div class="flex items-center">
                                <input id="save-template-checkbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-600 rounded focus:ring-blue-500 bg-gray-700">
                                <label for="save-template-checkbox" class="ml-2 block text-sm text-gray-300">Save as Payment Template</label>
                            </div>
                            <div id="template-name-wrapper" class="hidden">
                                <label for="template-name-input" class="block text-sm font-medium text-gray-300">Template Name</label>
                                <input type="text" id="template-name-input" class="mt-1 w-full md:w-1/2 px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400" placeholder="e.g., Rent, Phone Bill">
                            </div>
                        </div>

                        <div class="mt-6 flex space-x-4">
                            <button type="submit" id="submit-payment-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-blue-700 transition duration-150">Add Payment</button>
                            <button type="button" id="cancel-edit-btn" class="hidden bg-gray-500 text-white px-6 py-2 rounded-lg shadow-md hover:bg-gray-600 transition duration-150">Cancel Edit</button>
                        </div>
                        <input type="hidden" id="payment-id-hidden">
                    </form>

                    <!-- Filter Payments (NEW) -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-100 mb-4">Filter Payments</h3>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <label for="filter-name" class="block text-sm font-medium text-gray-300">Name</label>
                                <select id="filter-name" class="mt-1 w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white">
                                    <option value="">All People</option>
                                    <!-- Names populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="filter-category" class="block text-sm font-medium text-gray-300">Category</label>
                                <select id="filter-category" class="mt-1 w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white">
                                    <option value="">All Categories</option>
                                    <!-- Categories populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="filter-start-date" class="block text-sm font-medium text-gray-300">Start Date</label>
                                <input type="date" id="filter-start-date" class="mt-1 w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400">
                            </div>
                            <div>
                                <label for="filter-end-date" class="block text-sm font-medium text-gray-300">End Date</label>
                                <input type="date" id="filter-end-date" class="mt-1 w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400">
                            </div>
                            <div class="flex items-end">
                                <button id="filter-reset-btn" class="w-full bg-gray-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-gray-700 transition duration-150">Reset</button>
                            </div>
                        </div>
                    </div>


                    <!-- All Payments Table -->
                    <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                        <div class="flex justify-between items-center p-6">
                            <h3 class="text-xl font-semibold text-gray-100">All Payments</h3>
                             <button id="export-filtered-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition duration-150">Export Filtered (CSV)</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Name</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Category</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Amount</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Notes</th> <!-- NEW -->
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="payments-table-body" class="bg-gray-800 divide-y divide-gray-700">
                                    <!-- Rows populated by JS -->
                                </tbody>
                            </table>
                        </div>
                        <p id="no-payments-msg" class="p-6 text-center text-gray-400 hidden">No payments recorded yet.</p>
                        <p id="no-filtered-payments-msg" class="p-6 text-center text-gray-400 hidden">No payments match the current filters.</p>
                    </div>

                    <!-- Manage Templates (NEW) -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-gray-100">Manage Templates</h3>
                        <ul id="template-list" class="space-y-3">
                            <!-- List populated by JS -->
                        </ul>
                        <p id="no-templates-list-msg" class="text-center text-gray-400 hidden">No templates saved yet.</p>
                    </div>
                </section>

                <!-- Manage People Tab -->
                <section id="people-tab" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Add/Edit Person Form -->
                    <form id="person-form" class="bg-gray-800 p-6 rounded-lg shadow-lg h-fit">
                        <h3 id="person-form-title" class="text-xl font-semibold mb-4 text-gray-100">Add New Person</h3>
                        <div class="flex space-x-4">
                            <input type="text" id="person-name" placeholder="Enter new name" required class="flex-1 px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400">
                            <button type="submit" id="submit-person-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-green-700 transition duration-150">Add</button>
                        </div>
                         <div class="mt-4">
                             <button type="button" id="cancel-person-edit-btn" class="hidden w-full bg-gray-500 text-white px-6 py-2 rounded-lg shadow-md hover:bg-gray-600 transition duration-150">Cancel Edit</button>
                        </div>
                        <input type="hidden" id="person-id-hidden">
                        <input type="hidden" id="person-old-name-hidden">
                    </form>

                    <!-- People List -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-gray-100">People List</h3>
                        <ul id="people-list" class="space-y-3">
                            <!-- List populated by JS -->
                        </ul>
                        <p id="no-people-msg" class="text-center text-gray-400 hidden">No people added yet.</p>
                    </div>
                </section>

                <!-- Manage Categories Tab -->
                <section id="categories-tab" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Add/Edit Category Form -->
                    <form id="category-form" class="bg-gray-800 p-6 rounded-lg shadow-lg h-fit">
                        <h3 id="category-form-title" class="text-xl font-semibold mb-4 text-gray-100">Add New Category</h3>
                        <div class="flex space-x-4">
                            <input type="text" id="category-name" placeholder="Enter new category" required class="flex-1 px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400">
                            <button type="submit" id="submit-category-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-green-700 transition duration-150">Add</button>
                        </div>
                         <div class="mt-4">
                             <button type="button" id="cancel-category-edit-btn" class="hidden w-full bg-gray-500 text-white px-6 py-2 rounded-lg shadow-md hover:bg-gray-600 transition duration-150">Cancel Edit</button>
                        </div>
                        <input type="hidden" id="category-id-hidden">
                        <input type="hidden" id="category-old-name-hidden">
                    </form>

                    <!-- Category List -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-gray-100">Category List</h3>
                        <ul id="category-list" class="space-y-3">
                            <!-- List populated by JS -->
                        </ul>
                        <p id="no-categories-msg" class="text-center text-gray-400 hidden">No categories added yet.</p>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, query, where, setDoc, serverTimestamp, writeBatch, setLogLevel, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config (Hard-coded as requested) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJ9K9fQ0ThMB7aXB6qNHr3_yLUdqJgnCM",
            authDomain: "my-chain-reaction-game.firebaseapp.com",
            projectId: "my-chain-reaction-game",
            storageBucket: "my-chain-reaction-game.appspot.com",
            messagingSenderId: "32751418407",
            appId: "1:32751418407:web:ff8244007ef2b099d56202"
        };
        
        // --- App & Firebase Globals ---
        let app, auth, db;
        let userId = null;
        let unsubscribePayments = null;
        let unsubscribePeople = null;
        let unsubscribeCategories = null;
        let unsubscribeTemplates = null;
        let paymentsCache = [];
        let peopleCache = [];
        let categoriesCache = [];
        let templatesCache = [];
        let filteredPaymentsCache = [];
        let personsChartInstance = null;
        let monthlyChartInstance = null;
        let categoriesChartInstance = null;
        let userMonthlyChartInstance = null;
        let dashboardDateFilter = 'all';
        
        // --- CRITICAL FIX ---
        const appId = 'my-chain-reaction-game';
        
        // --- UI Element Globals ---
        // Auth
        const authSection = document.getElementById('auth-section');
        const appSection = document.getElementById('app-section');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailSpan = document.getElementById('user-email');
        const authError = document.getElementById('auth-error');
        const authLoading = document.getElementById('auth-loading');
        const configError = document.getElementById('config-error');

        // Tabs
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Payments
        const paymentForm = document.getElementById('payment-form');
        const formTitle = document.getElementById('form-title');
        const paymentDate = document.getElementById('payment-date');
        const paymentNameInput = document.getElementById('payment-name-input');
        const paymentNameDatalist = document.getElementById('payment-name-list');
        const paymentCategoryInput = document.getElementById('payment-category-input');
        const paymentCategoryDatalist = document.getElementById('payment-category-list');
        const paymentAmount = document.getElementById('payment-amount');
        const paymentNotes = document.getElementById('payment-notes');
        const submitPaymentBtn = document.getElementById('submit-payment-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const paymentIdHidden = document.getElementById('payment-id-hidden');
        const paymentsTableBody = document.getElementById('payments-table-body');
        const noPaymentsMsg = document.getElementById('no-payments-msg');
        const noFilteredPaymentsMsg = document.getElementById('no-filtered-payments-msg');

        // Payment Templates
        const saveTemplateCheckbox = document.getElementById('save-template-checkbox');
        const templateNameWrapper = document.getElementById('template-name-wrapper');
        const templateNameInput = document.getElementById('template-name-input');
        const templateButtonsContainer = document.getElementById('template-buttons');
        const noTemplatesMsg = document.getElementById('no-templates-msg');
        const templateList = document.getElementById('template-list');
        const noTemplatesListMsg = document.getElementById('no-templates-list-msg');
        
        // Payment Filters
        const filterName = document.getElementById('filter-name');
        const filterCategory = document.getElementById('filter-category');
        const filterStartDate = document.getElementById('filter-start-date');
        const filterEndDate = document.getElementById('filter-end-date');
        const filterResetBtn = document.getElementById('filter-reset-btn');

        // People
        const personForm = document.getElementById('person-form');
        const personNameInput = document.getElementById('person-name');
        const peopleList = document.getElementById('people-list');
        const noPeopleMsg = document.getElementById('no-people-msg');
        const personFormTitle = document.getElementById('person-form-title');
        const submitPersonBtn = document.getElementById('submit-person-btn');
        const cancelPersonEditBtn = document.getElementById('cancel-person-edit-btn');
        const personIdHidden = document.getElementById('person-id-hidden');
        const personOldNameHidden = document.getElementById('person-old-name-hidden');

        // Categories
        const categoryForm = document.getElementById('category-form');
        const categoryNameInput = document.getElementById('category-name');
        const categoryList = document.getElementById('category-list');
        const noCategoriesMsg = document.getElementById('no-categories-msg');
        const categoryFormTitle = document.getElementById('category-form-title');
        const submitCategoryBtn = document.getElementById('submit-category-btn');
        const cancelCategoryEditBtn = document.getElementById('cancel-category-edit-btn');
        const categoryIdHidden = document.getElementById('category-id-hidden');
        const categoryOldNameHidden = document.getElementById('category-old-name-hidden');
        
        // Dashboard
        const dashboardFilterButtons = document.querySelectorAll('.filter-btn');
        const totalSpendingEl = document.getElementById('total-spending');
        const topSpendersDiv = document.getElementById('top-spenders'); // NEW
        const monthlyReportYearSelect = document.getElementById('monthly-report-year');
        const noCategoryDataMsg = document.getElementById('no-category-data-msg');

        // User Report
        const userReportPersonSelect = document.getElementById('user-report-person-select');
        const userReportPeriodSelect = document.getElementById('user-report-period-select');
        const userReportNoDataMsg = document.getElementById('user-report-no-data-msg');

        // Export
        const exportFilteredBtn = document.getElementById('export-filtered-btn');
        
        // --- Chart Config ---
        const CHART_COLORS = [
            '#3b82f6', '#10b981', '#ef4444', '#f97316', '#a855f7', '#eab308', 
            '#ec4899', '#6366f1', '#06b6d4', '#f43f5e', '#84cc16', '#22c55e'
        ];
        Chart.defaults.color = '#e5e7eb'; // gray-200
        Chart.defaults.borderColor = '#4b5563'; // gray-600

        /**
         * Utility: Show toast message
         */
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('hidden');
            if (isError) {
                toast.classList.add('bg-red-600');
                toast.classList.remove('bg-green-600');
            } else {
                toast.classList.add('bg-green-600');
                toast.classList.remove('bg-red-600');
            }
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        /**
         * Utility: Format number as INR currency
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
            }).format(amount);
        }

        /**
         * Utility: Format "YYYY-MM" to "Mon YYYY"
         */
        function formatDateToMonYYYY(yyyy_mm) {
            const [year, month] = yyyy_mm.split('-');
            const date = new Date(year, month - 1); // month is 0-indexed
            return date.toLocaleString('default', { month: 'short', year: 'numeric' });
        }

        // --- Firebase Initialization & Auth ---

        /**
         * Initializes the Firebase app and auth.
         */
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Enable Firestore logging
                console.log("Firebase initialized successfully.");
                setupAuthListener();
            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                configError.textContent = "Error: Failed to initialize app. Please check console.";
                configError.classList.remove('hidden');
                authLoading.classList.add('hidden');
            }
        }

        /**
         * Sets up the listener for auth state changes.
         */
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in
                    console.log("User is signed in:", user.uid);
                    userId = user.uid;
                    userEmailSpan.textContent = user.email;
                    userEmailSpan.classList.remove('hidden');
                    logoutBtn.classList.remove('hidden');
                    authSection.classList.add('hidden');
                    appSection.classList.remove('hidden');
                    
                    paymentDate.value = new Date().toISOString().split('T')[0];
                    
                    attachFirestoreListeners();
                    
                } else {
                    // User is signed out
                    console.log("User is signed out.");
                    userId = null;
                    userEmailSpan.textContent = '';
                    userEmailSpan.classList.add('hidden');
                    logoutBtn.classList.add('hidden');
                    authSection.classList.remove('hidden');
                    appSection.classList.add('hidden');
                    
                    if (unsubscribePayments) unsubscribePayments();
                    if (unsubscribePeople) unsubscribePeople();
                    if (unsubscribeCategories) unsubscribeCategories();
                    if (unsubscribeTemplates) unsubscribeTemplates();
                    
                    paymentsCache = [];
                    peopleCache = [];
                    categoriesCache = [];
                    templatesCache = [];
                    filteredPaymentsCache = [];
                }
                authLoading.classList.add('hidden');
            });
        }

        /**
         * Handles user login.
         */
        async function handleLogin() {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                authError.textContent = "Please enter both email and password.";
                return;
            }
            authError.textContent = "";
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error.message);
                authError.textContent = `Login failed: ${error.message}`;
            }
        }

        /**
         * Handles user signup.
         */
        async function handleSignup() {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                authError.textContent = "Please enter both email and password.";
                return;
            }
            if (password.length < 6) {
                authError.textContent = "Password must be at least 6 characters.";
                return;
            }
            authError.textContent = "";

            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Signup failed:", error.message);
                authError.textContent = `Signup failed: ${error.message}`;
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout failed:", error);
                showToast("Logout failed. Please try again.", true);
            }
        }

        // --- Tab Navigation ---

        /**
         * Handles tab switching.
         */
        function handleTabClick(e) {
            const clickedTab = e.currentTarget;
            const tabName = clickedTab.dataset.tab;

            tabButtons.forEach(btn => btn.classList.remove('active'));
            clickedTab.classList.add('active');

            tabContents.forEach(content => {
                if (content.id === `${tabName}-tab`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
            
            if (tabName === 'dashboard' && paymentsCache.length > 0) {
                 updateDashboard();
            }
        }

        // --- Firestore & Data Logic ---

        /**
         * Attaches real-time listeners for all data collections.
         */
        function attachFirestoreListeners() {
            if (!userId) return;
            
            if (unsubscribePayments) unsubscribePayments();
            if (unsubscribePeople) unsubscribePeople();
            if (unsubscribeCategories) unsubscribeCategories();
            if (unsubscribeTemplates) unsubscribeTemplates();

            // --- People Listener ---
            const peoplePath = `/artifacts/${appId}/users/${userId}/persons`;
            const peopleQuery = query(collection(db, peoplePath));
            
            unsubscribePeople = onSnapshot(peopleQuery, (snapshot) => {
                console.log("People listener updated.");
                peopleCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                peopleCache.sort((a, b) => a.name.localeCompare(b.name));
                
                renderPeopleList(peopleCache);
                updatePaymentNameDatalist(peopleCache);
                populatePaymentFilterSelects();
                populateUserReportPersonSelect(peopleCache);
                
            }, (error) => console.error("Error in people listener:", error));

            // --- Categories Listener ---
            const categoriesPath = `/artifacts/${appId}/users/${userId}/categories`;
            const categoriesQuery = query(collection(db, categoriesPath));
            
            unsubscribeCategories = onSnapshot(categoriesQuery, (snapshot) => {
                console.log("Categories listener updated.");
                categoriesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                categoriesCache.sort((a, b) => a.name.localeCompare(b.name));
                
                renderCategoriesList(categoriesCache);
                updatePaymentCategoryDatalist(categoriesCache);
                populatePaymentFilterSelects();
                
            }, (error) => console.error("Error in categories listener:", error));

            // --- Templates Listener (New) ---
            const templatesPath = `/artifacts/${appId}/users/${userId}/paymentTemplates`;
            const templatesQuery = query(collection(db, templatesPath));
            
            unsubscribeTemplates = onSnapshot(templatesQuery, (snapshot) => {
                console.log("Templates listener updated.");
                templatesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                templatesCache.sort((a, b) => a.templateName.localeCompare(b.templateName));
                
                renderTemplateButtons(templatesCache);
                renderTemplateList(templatesCache);
                
            }, (error) => console.error("Error in templates listener:", error));

            // --- Payments Listener ---
            const paymentsPath = `/artifacts/${appId}/users/${userId}/payments`;
            const paymentsQuery = query(collection(db, paymentsPath));

            unsubscribePayments = onSnapshot(paymentsQuery, (snapshot) => {
                console.log("Payments listener updated.");
                paymentsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                paymentsCache.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                applyAndRenderPaymentFilters();
                updateDashboard();
                
            }, (error) => console.error("Error in payments listener:", error));
        }

        // --- People Management ---
        function renderPeopleList(people) {
            peopleList.innerHTML = '';
            
            if (people.length === 0) {
                noPeopleMsg.classList.remove('hidden');
            } else {
                noPeopleMsg.classList.add('hidden');
                people.forEach(person => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-3 bg-gray-700 rounded-lg';
                    li.innerHTML = `
                        <span class="text-gray-100">${person.name}</span>
                        <div class="flex space-x-2">
                            <button data-id="${person.id}" data-name="${person.name}" class="edit-person-btn text-blue-400 hover:text-blue-300">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                            <button data-id="${person.id}" data-name="${person.name}" class="delete-person-btn text-red-500 hover:text-red-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    peopleList.appendChild(li);
                });
            }
        }
        async function handleSubmitPerson(e) {
            e.preventDefault();
            const newName = personNameInput.value.trim();
            if (!newName) return;

            const personId = personIdHidden.value;
            const oldName = personOldNameHidden.value;
            
            const existingPerson = peopleCache.find(p => p.name.toLowerCase() === newName.toLowerCase());
            
            if (personId) {
                if (existingPerson && existingPerson.id !== personId) {
                     showToast("This name is already used by another person.", true);
                     return;
                }
                
                try {
                    const batch = writeBatch(db);
                    const personDocPath = `/artifacts/${appId}/users/${userId}/persons/${personId}`;
                    batch.update(doc(db, personDocPath), { name: newName });
                    
                    const paymentsPath = `/artifacts/${appId}/users/${userId}/payments`;
                    const paymentsQuery = query(collection(db, paymentsPath), where("name", "==", oldName));
                    
                    const querySnapshot = await getDocs(paymentsQuery);
                    querySnapshot.forEach((paymentDoc) => {
                        batch.update(paymentDoc.ref, { name: newName });
                    });
                    
                    await batch.commit();
                    showToast("Person and all associated payments updated!");
                    resetPersonForm();
                    
                } catch (error) {
                    console.error("Error updating person and payments:", error);
                    showToast("Failed to update person.", true);
                }
                
            } else {
                if (existingPerson) {
                    showToast("This person already exists.", true);
                    return;
                }

                try {
                    const personsPath = `/artifacts/${appId}/users/${userId}/persons`;
                    const personsRef = collection(db, personsPath);
                    await addDoc(personsRef, { name: newName, createdAt: serverTimestamp() });
                    
                    personNameInput.value = '';
                    showToast("Person added successfully!");
                    
                } catch (error) {
                    console.error("Error adding person:", error);
                    showToast("Failed to add person.", true);
                }
            }
        }
        function handleEditPerson(personId, personName) {
            personNameInput.value = personName;
            personIdHidden.value = personId;
            personOldNameHidden.value = personName;
            personFormTitle.textContent = "Edit Person's Name";
            submitPersonBtn.textContent = "Update Name";
            cancelPersonEditBtn.classList.remove('hidden');
            personForm.scrollIntoView({ behavior: 'smooth' });
            personNameInput.focus();
        }
        function resetPersonForm() {
            personForm.reset();
            personIdHidden.value = '';
            personOldNameHidden.value = '';
            personFormTitle.textContent = 'Add New Person';
            submitPersonBtn.textContent = 'Add';
            cancelPersonEditBtn.classList.add('hidden');
        }
        async function handleDeletePerson(personId, personName) {
            const hasPayments = paymentsCache.some(p => p.name === personName);
            
            if (hasPayments) {
                showToast("Cannot delete person. They are associated with payments.", true);
                return;
            }
            
            try {
                const personPath = `/artifacts/${appId}/users/${userId}/persons/${personId}`;
                await deleteDoc(doc(db, personPath));
                showToast("Person deleted.");
                resetPersonForm();
                
            } catch (error) {
                console.error("Error deleting person:", error);
                showToast("Failed to delete person.", true);
            }
        }

        /**
         * Populates the <datalist> in the payment form for names.
         */
        function updatePaymentNameDatalist(people) {
            paymentNameDatalist.innerHTML = '';
            people.forEach(person => {
                const option = document.createElement('option');
                option.value = person.name;
                paymentNameDatalist.appendChild(option);
            });
        }

        // --- Category Management ---
        function renderCategoriesList(categories) {
            categoryList.innerHTML = '';
            
            if (categories.length === 0) {
                noCategoriesMsg.classList.remove('hidden');
            } else {
                noCategoriesMsg.classList.add('hidden');
                categories.forEach(category => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-3 bg-gray-700 rounded-lg';
                    li.innerHTML = `
                        <span class="text-gray-100">${category.name}</span>
                        <div class="flex space-x-2">
                            <button data-id="${category.id}" data-name="${category.name}" class="edit-category-btn text-blue-400 hover:text-blue-300">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                            <button data-id="${category.id}" data-name="${category.name}" class="delete-category-btn text-red-500 hover:text-red-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    categoryList.appendChild(li);
                });
            }
        }
        async function handleSubmitCategory(e) {
            e.preventDefault();
            const newName = categoryNameInput.value.trim();
            if (!newName) return;

            const categoryId = categoryIdHidden.value;
            const oldName = categoryOldNameHidden.value;
            
            const existingCategory = categoriesCache.find(c => c.name.toLowerCase() === newName.toLowerCase());
            
            if (categoryId) {
                // Edit Mode
                if (existingCategory && existingCategory.id !== categoryId) {
                    showToast("This category name is already used.", true);
                    return;
                }
                
                try {
                    const batch = writeBatch(db);
                    const categoryDocPath = `/artifacts/${appId}/users/${userId}/categories/${categoryId}`;
                    batch.update(doc(db, categoryDocPath), { name: newName });
                    
                    const paymentsPath = `/artifacts/${appId}/users/${userId}/payments`;
                    const paymentsQuery = query(collection(db, paymentsPath), where("category", "==", oldName));
                    
                    const querySnapshot = await getDocs(paymentsQuery);
                    querySnapshot.forEach((paymentDoc) => {
                        batch.update(paymentDoc.ref, { category: newName });
                    });
                    
                    await batch.commit();
                    showToast("Category and all associated payments updated!");
                    resetCategoryForm();
                    
                } catch (error) {
                    console.error("Error updating category and payments:", error);
                    showToast("Failed to update category.", true);
                }
                
            } else {
                // Add Mode
                if (existingCategory) {
                    showToast("This category already exists.", true);
                    return;
                }

                try {
                    const categoriesPath = `/artifacts/${appId}/users/${userId}/categories`;
                    await addDoc(collection(db, categoriesPath), { name: newName, createdAt: serverTimestamp() });
                    
                    categoryNameInput.value = '';
                    showToast("Category added successfully!");
                    
                } catch (error) {
                    console.error("Error adding category:", error);
                    showToast("Failed to add category.", true);
                }
            }
        }
        function handleEditCategory(categoryId, categoryName) {
            categoryNameInput.value = categoryName;
            categoryIdHidden.value = categoryId;
            categoryOldNameHidden.value = categoryName;
            categoryFormTitle.textContent = "Edit Category Name";
            submitCategoryBtn.textContent = "Update Name";
            cancelCategoryEditBtn.classList.remove('hidden');
            categoryForm.scrollIntoView({ behavior: 'smooth' });
            categoryNameInput.focus();
        }
        function resetCategoryForm() {
            categoryForm.reset();
            categoryIdHidden.value = '';
            categoryOldNameHidden.value = '';
            categoryFormTitle.textContent = 'Add New Category';
            submitCategoryBtn.textContent = 'Add';
            cancelCategoryEditBtn.classList.add('hidden');
        }
        async function handleDeleteCategory(categoryId, categoryName) {
            const hasPayments = paymentsCache.some(p => p.category === categoryName);
            
            if (hasPayments) {
                showToast("Cannot delete category. It is associated with payments.", true);
                return;
            }
            
            try {
                const categoryPath = `/artifacts/${appId}/users/${userId}/categories/${categoryId}`;
                await deleteDoc(doc(db, categoryPath));
                showToast("Category deleted.");
                resetCategoryForm();
                
            } catch (error) {
                console.error("Error deleting category:", error);
                showToast("Failed to delete category.", true);
            }
        }

        /**
         * Populates the <datalist> in the payment form for categories.
         */
        function updatePaymentCategoryDatalist(categories) {
            paymentCategoryDatalist.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                paymentCategoryDatalist.appendChild(option);
            });
        }
        

        // --- Payment Management ---

        /**
         * Applies filters to the paymentsCache and renders the table.
         */
        function applyAndRenderPaymentFilters() {
            const name = filterName.value;
            const category = filterCategory.value;
            const startDate = filterStartDate.value;
            const endDate = filterEndDate.value;
            
            filteredPaymentsCache = paymentsCache.filter(payment => {
                if (name && payment.name !== name) return false;
                if (category && payment.category !== category) return false;
                if (startDate && payment.date < startDate) return false;
                if (endDate && payment.date > endDate) return false;
                return true;
            });
            
            renderPaymentsTable(filteredPaymentsCache);
        }

        /**
         * Populates the filter <select> dropdowns.
         */
        function populatePaymentFilterSelects() {
            // Populate Name Filter
            const currentName = filterName.value;
            filterName.innerHTML = '<option value="">All People</option>';
            peopleCache.forEach(person => {
                const option = document.createElement('option');
                option.value = person.name;
                option.textContent = person.name;
                filterName.appendChild(option);
            });
            filterName.value = currentName; // Preserve selection

            // Populate Category Filter
            const currentCategory = filterCategory.value;
            filterCategory.innerHTML = '<option value="">All Categories</option>';
            categoriesCache.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                filterCategory.appendChild(option);
            });
            filterCategory.value = currentCategory; // Preserve selection
        }

        /**
         * Resets all payment filters.
         */
        function resetPaymentFilters() {
            filterName.value = '';
            filterCategory.value = '';
            filterStartDate.value = '';
            filterEndDate.value = '';
            applyAndRenderPaymentFilters();
        }

        /**
         * Renders the payments table.
         * @param {Array} payments - The *filtered* array of payments to display.
         */
        function renderPaymentsTable(payments) {
            paymentsTableBody.innerHTML = '';
            
            if (paymentsCache.length === 0) {
                // No payments at all
                noPaymentsMsg.classList.remove('hidden');
                noFilteredPaymentsMsg.classList.add('hidden');
            } else if (payments.length === 0) {
                // Payments exist, but none match filters
                noPaymentsMsg.classList.add('hidden');
                noFilteredPaymentsMsg.classList.remove('hidden');
            } else {
                // Show filtered payments
                noPaymentsMsg.classList.add('hidden');
                noFilteredPaymentsMsg.classList.add('hidden');
                
                payments.forEach(payment => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-700";
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-100">${payment.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-100">${payment.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-100">${payment.category || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-100">${formatCurrency(payment.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 truncate max-w-xs">${payment.notes || ''}</td> <!-- NEW -->
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right space-x-2">
                            <button data-id="${payment.id}" class="edit-payment-btn text-blue-400 hover:text-blue-300">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                            <button data-id="${payment.id}" class="delete-payment-btn text-red-500 hover:text-red-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </td>
                    `;
                    paymentsTableBody.appendChild(tr);
                });
            }
        }

        /**
         * Handles submission of the Add/Edit Payment form.
         */
        async function handleSubmitPayment(e) {
            e.preventDefault();
            
            const paymentData = {
                date: paymentDate.value,
                name: paymentNameInput.value,
                category: paymentCategoryInput.value,
                amount: parseFloat(paymentAmount.value),
                notes: paymentNotes.value.trim(), // NEW
            };
            
            // Validation
            if (!paymentData.date || !paymentData.name || !paymentData.category || isNaN(paymentData.amount) || paymentData.amount <= 0) {
                showToast("Please fill in all fields (including category) with valid data.", true);
                return;
            }
            if (!peopleCache.some(p => p.name === paymentData.name)) {
                showToast("Person not found. Please add them from the 'Manage People' tab first.", true);
                return;
            }
            if (!categoriesCache.some(c => c.name === paymentData.category)) {
                showToast("Category not found. Please add it from the 'Manage Categories' tab first.", true);
                return;
            }
            
            const paymentId = paymentIdHidden.value;
            
            try {
                if (paymentId) {
                    // Update existing payment
                    const paymentPath = `/artifacts/${appId}/users/${userId}/payments/${paymentId}`;
                    await updateDoc(doc(db, paymentPath), paymentData);
                    showToast("Payment updated!");
                } else {
                    // Add new payment
                    const paymentsPath = `/artifacts/${appId}/users/${userId}/payments`;
                    await addDoc(collection(db, paymentsPath), {
                        ...paymentData,
                        createdAt: serverTimestamp()
                    });
                    showToast("Payment added!");
                }
                
                // Handle template saving (New)
                if (saveTemplateCheckbox.checked) {
                    const templateName = templateNameInput.value.trim();
                    if (!templateName) {
                        showToast("Please enter a template name to save it.", true);
                    } else {
                        await savePaymentTemplate(templateName, paymentData);
                    }
                }
                
                resetPaymentForm();
                
            } catch (error) {
                console.error("Error saving payment:", error);
                showToast("Failed to save payment.", true);
            }
        }
        
        /**
         * Resets the payment form to its default (add) state.
         */
        function resetPaymentForm() {
            paymentForm.reset();
            paymentIdHidden.value = '';
            paymentDate.value = new Date().toISOString().split('T')[0];
            formTitle.textContent = "Add New Payment";
            submitPaymentBtn.textContent = "Add Payment";
            cancelEditBtn.classList.add('hidden');
            saveTemplateCheckbox.checked = false;
            templateNameWrapper.classList.add('hidden');
            templateNameInput.value = '';
            paymentNotes.value = ''; // NEW
        }

        /**
         * Populates the payment form for editing.
         */
        function handleEditPayment(paymentId) {
            const payment = paymentsCache.find(p => p.id === paymentId);
            if (!payment) {
                showToast("Could not find payment to edit.", true);
                return;
            }
            
            paymentDate.value = payment.date;
            paymentNameInput.value = payment.name;
            paymentCategoryInput.value = payment.category;
            paymentAmount.value = payment.amount;
            paymentNotes.value = payment.notes || ''; // NEW
            paymentIdHidden.value = paymentId;
            
            formTitle.textContent = "Edit Payment";
            submitPaymentBtn.textContent = "Update Payment";
            cancelEditBtn.classList.remove('hidden');
            
            paymentForm.scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * Handles deleting a payment.
         */
        async function handleDeletePayment(paymentId) {
            try {
                const paymentPath = `/artifacts/${appId}/users/${userId}/payments/${paymentId}`;
                await deleteDoc(doc(db, paymentPath));
                showToast("Payment deleted.");
                resetPaymentForm();
                
            } catch (error) {
                console.error("Error deleting payment:", error);
                showToast("Failed to delete payment.", true);
            }
        }

        // --- Payment Templates (NEW) ---

        /**
         * Saves or updates a payment template.
         */
        async function savePaymentTemplate(templateName, paymentData) {
            const existingTemplate = templatesCache.find(t => t.templateName.toLowerCase() === templateName.toLowerCase());
            
            const templateData = {
                templateName: templateName,
                name: paymentData.name,
                category: paymentData.category,
                amount: paymentData.amount,
                notes: paymentData.notes
            };
            
            try {
                const templatesPath = `/artifacts/${appId}/users/${userId}/paymentTemplates`;
                if (existingTemplate) {
                    // Update existing template
                    const templateDoc = doc(db, templatesPath, existingTemplate.id);
                    await updateDoc(templateDoc, templateData);
                    showToast(`Template "${templateName}" updated!`);
                } else {
                    // Add new template
                    await addDoc(collection(db, templatesPath), { ...templateData, createdAt: serverTimestamp() });
                    showToast(`Template "${templateName}" saved!`);
                }
            } catch (error) {
                console.error("Error saving template:", error);
                showToast("Failed to save template.", true);
            }
        }
        
        /**
         * Renders the quick-add template buttons.
         */
        function renderTemplateButtons(templates) {
            templateButtonsContainer.innerHTML = '';
            if (templates.length === 0) {
                noTemplatesMsg.classList.remove('hidden');
                return;
            }
            
            noTemplatesMsg.classList.add('hidden');
            templates.forEach(template => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition duration-150 text-sm';
                button.textContent = template.templateName;
                button.dataset.id = template.id;
                button.addEventListener('click', () => populateFormFromTemplate(template.id));
                templateButtonsContainer.appendChild(button);
            });
        }

        /**
         * Renders the "Manage Templates" list.
         */
        function renderTemplateList(templates) {
            templateList.innerHTML = '';
            if (templates.length === 0) {
                noTemplatesListMsg.classList.remove('hidden');
                return;
            }
            
            noTemplatesListMsg.classList.add('hidden');
            templates.forEach(template => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 bg-gray-700 rounded-lg';
                li.innerHTML = `
                    <div>
                        <span class="text-gray-100 font-semibold">${template.templateName}</span>
                        <p class="text-sm text-gray-400">${template.name} | ${template.category} | ${formatCurrency(template.amount)}</p>
                        <p class="text-sm text-gray-300 italic">${template.notes || 'No notes'}</p>
                    </div>
                    <button data-id="${template.id}" class="delete-template-btn text-red-500 hover:text-red-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                templateList.appendChild(li);
            });
        }

        /**
         * Populates the payment form from a saved template.
         */
        function populateFormFromTemplate(templateId) {
            const template = templatesCache.find(t => t.id === templateId);
            if (!template) return;
            
            paymentNameInput.value = template.name;
            paymentCategoryInput.value = template.category;
            paymentAmount.value = template.amount;
            paymentNotes.value = template.notes || '';
            
            // Scroll to form and show toast
            paymentForm.scrollIntoView({ behavior: 'smooth' });
            showToast(`Form populated from "${template.templateName}". Just set the date and add!`);
        }

        /**
         * Deletes a payment template.
         */
        async function handleDeleteTemplate(templateId) {
            try {
                const templatePath = `/artifacts/${appId}/users/${userId}/paymentTemplates/${templateId}`;
                await deleteDoc(doc(db, templatePath));
                showToast("Template deleted.");
            } catch (error) {
                console.error("Error deleting template:", error);
                showToast("Failed to delete template.", true);
            }
        }
        
        // --- Dashboard & Charts ---
        function getFilteredDashboardPayments() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();

            switch (dashboardDateFilter) {
                case 'month':
                    return paymentsCache.filter(p => {
                        const pDate = new Date(p.date + 'T00:00:00'); // Ensure local date
                        return pDate.getFullYear() === currentYear && pDate.getMonth() === currentMonth;
                    });
                case 'year':
                    return paymentsCache.filter(p => {
                        const pDate = new Date(p.date + 'T00:00:00');
                        return pDate.getFullYear() === currentYear;
                    });
                case 'all':
                default:
                    return paymentsCache;
            }
        }
        function updateDashboard() {
            // Get the filtered list of payments for the dashboard
            const filteredPayments = getFilteredDashboardPayments();

            // 1. Update total spending
            const totalSpending = filteredPayments.reduce((sum, p) => sum + p.amount, 0);
            totalSpendingEl.textContent = formatCurrency(totalSpending);
            
            // UPDATED: Calculate and render top 5 spenders
            const spendingByPerson = filteredPayments.reduce((acc, payment) => {
                acc[payment.name] = (acc[payment.name] || 0) + payment.amount;
                return acc;
            }, {});

            const sortedSpenders = Object.entries(spendingByPerson)
                .sort(([, amountA], [, amountB]) => amountB - amountA);

            topSpendersDiv.innerHTML = ''; // Clear previous
            if (sortedSpenders.length === 0) {
                topSpendersDiv.innerHTML = '<p class="text-sm text-gray-400">No spending data for this period.</p>';
            } else {
                const ranks = ['1st:', '2nd:', '3rd:', '4th:', '5th:']; // UPDATED to 5
                sortedSpenders.slice(0, 5).forEach(([name, amount], index) => { // UPDATED to 5
                    const p = document.createElement('p');
                    p.className = 'text-sm text-gray-300 flex justify-between';
                    p.innerHTML = `
                        <span class="font-medium text-gray-100">${ranks[index]} ${name}</span>
                        <span class="text-blue-300">${formatCurrency(amount)}</span>
                    `;
                    topSpendersDiv.appendChild(p);
                });
            }

            // 2. Update charts
            renderPersonsChart(filteredPayments); // Pass filtered data
            renderCategoriesChart(filteredPayments); // Pass filtered data
            
            // 3. Populate year select (uses ALL payments)
            populateYearSelect(paymentsCache, monthlyReportYearSelect);
            
            // 4. Render monthly chart (uses its own year filter, not dashboard filter)
            renderMonthlyChart();

            // 5. Populate User Report Selects
            populateUserReportPersonSelect(peopleCache);
            populateUserReportPeriodSelect(paymentsCache);
            renderUserReportChart();
        }
        function renderPersonsChart(payments) {
            const ctx = document.getElementById('persons-chart').getContext('2d');
            
            const spending = payments.reduce((acc, payment) => {
                acc[payment.name] = (acc[payment.name] || 0) + payment.amount;
                return acc;
            }, {});

            const labels = Object.keys(spending);
            const data = Object.values(spending);
            
            const backgroundColors = labels.map((_, i) => CHART_COLORS[i % CHART_COLORS.length] + 'B3');
            const borderColors = labels.map((_, i) => CHART_COLORS[i % CHART_COLORS.length]);

            if (personsChartInstance) {
                personsChartInstance.destroy();
            }
            
            if (labels.length === 0) {
                return; // Don't render an empty chart
            }

            personsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Spending',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => ` ${formatCurrency(c.raw)}` } } },
                    scales: { y: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) } }, x: {} }
                }
            });
        }
        function renderCategoriesChart(payments) {
            const ctx = document.getElementById('categories-chart').getContext('2d');
            
            const spending = payments.reduce((acc, payment) => {
                const category = payment.category || 'Uncategorized';
                acc[category] = (acc[category] || 0) + payment.amount;
                return acc;
            }, {});

            const labels = Object.keys(spending);
            const data = Object.values(spending);
            
            const backgroundColors = labels.map((_, i) => CHART_COLORS[i % CHART_COLORS.length] + 'B3');
            const borderColors = labels.map((_, i) => CHART_COLORS[i % CHART_COLORS.length]);

            if (categoriesChartInstance) {
                categoriesChartInstance.destroy();
            }
            
            if (labels.length === 0) {
                noCategoryDataMsg.classList.remove('hidden');
                return;
            }
            noCategoryDataMsg.classList.add('hidden');

            categoriesChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Spending',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: { 
                                label: (c) => ` ${c.label}: ${formatCurrency(c.raw)}`
                            }
                        }
                    }
                }
            });
        }
        
        /**
         * Populates a given year select dropdown.
         * @param {Array} payments - The full payments cache.
         * @param {HTMLElement} selectElement - The <select> element to populate.
         */
        function populateYearSelect(payments, selectElement) {
            if (payments.length === 0) return;
            const years = [...new Set(payments.map(p => new Date(p.date + 'T00:00:00').getFullYear()))];
            years.sort((a, b) => b - a);
            const currentVal = selectElement.value;
            selectElement.innerHTML = '';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                selectElement.appendChild(option);
            });
            if (years.includes(parseInt(currentVal))) {
                selectElement.value = currentVal;
            } else {
                selectElement.value = years[0];
            }
        }
        
        function renderMonthlyChart() {
            const ctx = document.getElementById('monthly-chart').getContext('2d');
            const selectedYear = parseInt(monthlyReportYearSelect.value);

            if (isNaN(selectedYear)) {
                if (monthlyChartInstance) monthlyChartInstance.destroy();
                return;
            }
            
            const monthlyTotals = new Array(12).fill(0);
            const paymentsForYear = paymentsCache.filter(p => new Date(p.date + 'T00:00:00').getFullYear() === selectedYear);
            
            paymentsForYear.forEach(payment => {
                const month = new Date(payment.date + 'T00:00:00').getMonth();
                monthlyTotals[month] += payment.amount;
            });
            
            const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const data = monthlyTotals;
            
            if (monthlyChartInstance) {
                monthlyChartInstance.destroy();
            }

            monthlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Spending in ${selectedYear}`,
                        data: data,
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => ` ${formatCurrency(c.raw)}` } } },
                    scales: { y: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) } } }
                }
            });
        }
        function handleDashboardFilterClick(e) {
            const clickedFilter = e.currentTarget;
            dashboardDateFilter = clickedFilter.dataset.filter;

            // Update button styles
            dashboardFilterButtons.forEach(btn => btn.classList.remove('active'));
            clickedFilter.classList.add('active');

            // Re-render dashboard
            updateDashboard();
        }

        // --- UPDATED: User Payment Report Functions ---
        
        /**
         * Populates the User Report person <select> dropdown.
         */
        function populateUserReportPersonSelect(people) {
            const currentVal = userReportPersonSelect.value;
            userReportPersonSelect.innerHTML = '<option value="">-- Select a Person --</option>';
            people.forEach(person => {
                const option = document.createElement('option');
                option.value = person.name;
                option.textContent = person.name;
                userReportPersonSelect.appendChild(option);
            });
            // Preserve selection if possible
            if (people.some(p => p.name === currentVal)) {
                userReportPersonSelect.value = currentVal;
            }
        }
        
        /**
         * Populates the User Report period <select> dropdown.
         */
        function populateUserReportPeriodSelect(payments) {
            const currentVal = userReportPeriodSelect.value;
            userReportPeriodSelect.innerHTML = ''; // Clear

            if (payments.length === 0) {
                 userReportPeriodSelect.innerHTML = `<option value="total">Total</option><option value="${new Date().getFullYear()}">${new Date().getFullYear()} (Year)</option>`;
                return;
            }

            const periods = new Set();
            const years = new Set();
            payments.forEach(p => {
                const date = new Date(p.date + 'T00:00:00');
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                years.add(year.toString());
                periods.add(`${year}-${month}`);
            });

            const sortedPeriods = [...periods].sort().reverse();
            const sortedYears = [...years].sort().reverse();

            // Add Total
            const totalOpt = document.createElement('option');
            totalOpt.value = "total";
            totalOpt.textContent = "Total (All Time)";
            userReportPeriodSelect.appendChild(totalOpt);

            // Add Years
            sortedYears.forEach(year => {
                const opt = document.createElement('option');
                opt.value = year;
                opt.textContent = `${year} (Year)`;
                userReportPeriodSelect.appendChild(opt);
            });

            // Add Months
            sortedPeriods.forEach(period => {
                const opt = document.createElement('option');
                opt.value = period; // "YYYY-MM"
                opt.textContent = formatDateToMonYYYY(period); // "Mon YYYY"
                userReportPeriodSelect.appendChild(opt);
            });
            
            // Preserve selection if possible
            if ([...userReportPeriodSelect.options].some(opt => opt.value === currentVal)) {
                userReportPeriodSelect.value = currentVal;
            } else {
                userReportPeriodSelect.value = "total"; // Default to Total
            }
        }

        /**
         * Renders the chart for a specific user based on the selected period.
         */
        function renderUserReportChart() {
            const ctx = document.getElementById('user-monthly-chart').getContext('2d');
            const selectedPerson = userReportPersonSelect.value;
            const selectedPeriod = userReportPeriodSelect.value;

            if (userMonthlyChartInstance) {
                userMonthlyChartInstance.destroy();
            }

            if (!selectedPerson) {
                 userReportNoDataMsg.textContent = "Please select a person.";
                 userReportNoDataMsg.classList.remove('hidden');
                 return;
            }
            
            userReportNoDataMsg.classList.add('hidden'); // Hide by default
            let chartType = 'line'; // Default to line
            let labels = [];
            let data = [];
            let chartLabel = '';

            // --- Case 1: "Total" (All Time) ---
            if (selectedPeriod === 'total') {
                const paymentsForUser = paymentsCache.filter(p => p.name === selectedPerson);
                if (paymentsForUser.length === 0) {
                    userReportNoDataMsg.textContent = `No data found for ${selectedPerson}.`;
                    userReportNoDataMsg.classList.remove('hidden');
                    return;
                }
                
                // Aggregate by month (YYYY-MM)
                const spendingByMonth = paymentsForUser.reduce((acc, payment) => {
                    const monthYear = payment.date.substring(0, 7); // "YYYY-MM"
                    acc[monthYear] = (acc[monthYear] || 0) + payment.amount;
                    return acc;
                }, {});

                const sortedMonths = Object.keys(spendingByMonth).sort();
                
                if (sortedMonths.length === 0) {
                    userReportNoDataMsg.textContent = `No data found for ${selectedPerson}.`;
                    userReportNoDataMsg.classList.remove('hidden');
                    return;
                }

                // Fill in missing months to create a continuous line
                const firstMonth = sortedMonths[0];
                const lastMonth = sortedMonths[sortedMonths.length - 1];
                
                let currentDate = new Date(firstMonth + '-02T00:00:00'); // Use day 2 to avoid timezone issues
                const lastDate = new Date(lastMonth + '-02T00:00:00');
                
                const allMonthsData = {};
                
                while (currentDate <= lastDate) {
                    const year = currentDate.getFullYear();
                    const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                    const monthYearKey = `${year}-${month}`;
                    
                    allMonthsData[monthYearKey] = spendingByMonth[monthYearKey] || 0;
                    
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }

                labels = Object.keys(allMonthsData).map(formatDateToMonYYYY); // "Jan 2024"
                data = Object.values(allMonthsData);
                chartLabel = `Total Spending per Month for ${selectedPerson}`;


                if (data.length === 0) {
                    userReportNoDataMsg.textContent = `No data found for ${selectedPerson}.`;
                    userReportNoDataMsg.classList.remove('hidden');
                    return;
                }

            // --- Case 2: "YYYY" (Specific Year) ---
            } else if (selectedPeriod.length === 4) {
                const selectedYear = parseInt(selectedPeriod);
                const monthlyTotals = new Array(12).fill(0);
                
                const paymentsForUserYear = paymentsCache.filter(p => 
                    p.name === selectedPerson && 
                    new Date(p.date + 'T00:00:00').getFullYear() === selectedYear
                );
                
                let totalForYear = 0;
                paymentsForUserYear.forEach(payment => {
                    const month = new Date(payment.date + 'T00:00:00').getMonth();
                    monthlyTotals[month] += payment.amount;
                    totalForYear += payment.amount;
                });
                
                if (totalForYear === 0) {
                    userReportNoDataMsg.textContent = `No data for ${selectedPerson} in ${selectedYear}.`;
                    userReportNoDataMsg.classList.remove('hidden');
                    return;
                }
                
                labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                data = monthlyTotals;
                chartLabel = `Spending for ${selectedPerson} in ${selectedYear}`;

            // --- Case 3: "YYYY-MM" (Specific Month) ---
            } else if (selectedPeriod.length === 7) {
                const [year, month] = selectedPeriod.split('-').map(Number); // 1-based month
                
                const paymentsForUserMonth = paymentsCache.filter(p => {
                    const pDate = new Date(p.date + 'T00:00:00');
                    return p.name === selectedPerson &&
                           pDate.getFullYear() === year &&
                           (pDate.getMonth() + 1) === month;
                });

                if (paymentsForUserMonth.length === 0) {
                    userReportNoDataMsg.textContent = `No data for ${selectedPerson} in ${formatDateToMonYYYY(selectedPeriod)}.`;
                    userReportNoDataMsg.classList.remove('hidden');
                    return;
                }

                // Get days in month
                const daysInMonth = new Date(year, month, 0).getDate(); // 1-based month works here
                const dailyTotals = new Array(daysInMonth).fill(0);
                labels = Array.from({length: daysInMonth}, (_, i) => (i + 1).toString());

                // Aggregate by day
                paymentsForUserMonth.forEach(payment => {
                    const day = new Date(payment.date + 'T00:00:00').getDate(); // 1-based day
                    dailyTotals[day - 1] += payment.amount; // 0-indexed array
                });
                
                data = dailyTotals;
                chartLabel = `Daily Spending for ${selectedPerson} in ${formatDateToMonYYYY(selectedPeriod)}`;
            }

            // --- Render the Chart ---
            if (data.length > 0) {
                userMonthlyChartInstance = new Chart(ctx, {
                    type: 'line', // ALWAYS line chart
                    data: {
                        labels: labels,
                        datasets: [{
                            label: chartLabel,
                            data: data,
                            fill: true,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)', // CHANGED to blue
                            borderColor: 'rgba(59, 130, 246, 1)', // CHANGED to blue
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: true },
                            tooltip: { callbacks: { label: (c) => ` ${formatCurrency(c.raw)}` } } 
                        },
                        scales: { y: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) } } }
                    }
                });
            }
        }


        // --- Export to CSV ---

        /**
         * Creates and downloads a CSV file from the *filtered* payments list.
         */
        function handleExportFilteredCSV() {
            if (filteredPaymentsCache.length === 0) {
                showToast("No filtered data to export.", true);
                return;
            }

            // Generate CSV content from the filtered cache
            const header = `"Date","Name","Category","Amount","Notes"\n`;
            const rows = filteredPaymentsCache.map(p => 
                `"${p.date}","${p.name}","${p.category || 'N/A'}","${p.amount}","${p.notes || ''}"`
            ).join('\n');
            const csvContent = header + rows;

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'filtered_payments_export.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("Filtered export successful!");
        }

        // --- Event Listeners ---
        
        window.onload = initializeFirebase;
        
        // --- Auth Listeners ---
        loginBtn.addEventListener('click', handleLogin);
        signupBtn.addEventListener('click', handleSignup);
        logoutBtn.addEventListener('click', handleLogout);

        // --- Tab Listeners ---
        tabButtons.forEach(btn => btn.addEventListener('click', handleTabClick));

        // --- Dashboard Filter Listeners ---
        dashboardFilterButtons.forEach(btn => btn.addEventListener('click', handleDashboardFilterClick));

        // --- Form Listeners ---
        personForm.addEventListener('submit', handleSubmitPerson);
        cancelPersonEditBtn.addEventListener('click', resetPersonForm);
        categoryForm.addEventListener('submit', handleSubmitCategory);
        cancelCategoryEditBtn.addEventListener('click', resetCategoryForm);
        paymentForm.addEventListener('submit', handleSubmitPayment);
        cancelEditBtn.addEventListener('click', resetPaymentForm);
        monthlyReportYearSelect.addEventListener('change', renderMonthlyChart);
        saveTemplateCheckbox.addEventListener('change', () => {
            templateNameWrapper.classList.toggle('hidden', !saveTemplateCheckbox.checked);
        });

        // --- User Report Listeners ---
        userReportPersonSelect.addEventListener('change', renderUserReportChart);
        userReportPeriodSelect.addEventListener('change', renderUserReportChart);

        // --- Payment Filter Listeners (New) ---
        filterName.addEventListener('change', applyAndRenderPaymentFilters);
        filterCategory.addEventListener('change', applyAndRenderPaymentFilters);
        filterStartDate.addEventListener('change', applyAndRenderPaymentFilters);
        filterEndDate.addEventListener('change', applyAndRenderPaymentFilters);
        filterResetBtn.addEventListener('click', resetPaymentFilters);

        // --- Export Listeners ---
        exportFilteredBtn.addEventListener('click', handleExportFilteredCSV);

        // --- Dynamic Table/List Listeners (Event Delegation) ---
        
        // Listener for "People" list
        peopleList.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-person-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                const name = deleteBtn.dataset.name;
                handleDeletePerson(id, name);
                return;
            }
            const editBtn = e.target.closest('.edit-person-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                const name = editBtn.dataset.name;
                handleEditPerson(id, name);
            }
        });

        // Listener for "Categories" list
        categoryList.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-category-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                const name = deleteBtn.dataset.name;
                handleDeleteCategory(id, name);
                return;
            }
            const editBtn = e.target.closest('.edit-category-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                const name = editBtn.dataset.name;
                handleEditCategory(id, name);
            }
        });
        
        // Listener for "Payments" table
        paymentsTableBody.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-payment-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                handleDeletePayment(id);
                return;
            }
            const editBtn = e.target.closest('.edit-payment-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                handleEditPayment(id);
            }
        });

        // Listener for "Templates" list (New)
        templateList.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-template-btn');
            if (deleteBtn) {
                handleDeleteTemplate(deleteBtn.dataset.id);
            }
        });

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Manager Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
            color: #e5e7eb; /* gray-200 */
        }
        /* Simple tab highlighting */
        .tab-btn.active {
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            font-weight: 600;
        }
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        /* Dark mode for input[type=date] */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed top-5 right-5 z-50 p-4 rounded-lg shadow-lg max-w-sm text-white">
        <!-- Message will be injected here -->
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- Header -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-700">
            <h1 class="text-3xl font-bold text-blue-400">Payment Manager Pro</h1>
            <div id="auth-container" class="flex items-center space-x-2">
                <span id="user-email" class="text-gray-400 text-sm hidden"></span>
                <button id="logout-btn" class="hidden bg-red-600 text-white px-3 py-1 rounded-lg text-sm shadow-md hover:bg-red-700 transition duration-150">Logout</button>
            </div>
        </header>

        <!-- Auth Section -->
        <section id="auth-section" class="max-w-md mx-auto bg-gray-800 p-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-center text-gray-100 mb-6">Welcome</h2>
            <div class="space-y-4">
                <input type="email" id="email-input" placeholder="Email" class="w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400">
                <input type="password" id="password-input" placeholder="Password (min. 6 characters)" class="w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400">
                <div class="flex space-x-4">
                    <button id="login-btn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition duration-150">Login</button>
                    <button id="signup-btn" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-gray-700 transition duration-150">Sign Up</button>
                </div>
                <p id="auth-error" class="text-red-400 text-sm text-center"></p>
                <p id="auth-loading" class="text-blue-400 text-sm text-center hidden">Connecting...</p>
                <p id="config-error" class="text-yellow-400 text-sm text-center hidden"></p>
            </div>
        </section>

        <!-- Main App Section (hidden by default) -->
        <main id="app-section" class="hidden">
            <!-- Tab Navigation -->
            <nav class="mb-6 bg-gray-800 rounded-lg shadow-sm">
                <div class="flex border-b border-gray-700">
                    <button data-tab="dashboard" class="tab-btn active px-6 py-3 text-gray-400 hover:text-blue-400">Dashboard</button>
                    <button data-tab="payments" class="tab-btn px-6 py-3 text-gray-400 hover:text-blue-400">Payments</button>
                    <button data-tab="people" class="tab-btn px-6 py-3 text-gray-400 hover:text-blue-400">Manage People</button>
                </div>
            </nav>

            <!-- Tab Content -->
            <div>
                <!-- Dashboard Tab -->
                <section id="dashboard-tab" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Total Spending -->
                     <div class="bg-gray-800 p-6 rounded-lg shadow-lg lg:col-span-1">
                        <h3 class="text-xl font-semibold mb-4 text-gray-100">Total Spending</h3>
                        <p class="text-4xl font-bold text-blue-400" id="total-spending">...</p>
                    </div>
                    
                    <!-- Spending by Person -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg lg:col-span-2">
                        <h3 class="text-xl font-semibold mb-4 text-gray-100">Spending by Person</h3>
                        <!-- Wrapper DIV to constrain chart height -->
                        <div class="relative h-80">
                            <canvas id="persons-chart"></canvas>
                        </div>
                    </div>

                    <!-- Monthly Report -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg lg:col-span-3">
                        <h3 class="text-xl font-semibold mb-4 text-gray-100">Monthly Report</h3>
                        <select id="monthly-report-year" class="mb-4 w-full md:w-auto px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white">
                            <!-- Years will be populated by JS -->
                        </select>
                        <!-- Wrapper DIV to constrain chart height -->
                        <div class="relative h-96">
                            <canvas id="monthly-chart"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Payments Tab -->
                <section id="payments-tab" class="tab-content hidden space-y-6">
                    <!-- Add/Edit Payment Form -->
                    <form id="payment-form" class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 id="form-title" class="text-xl font-semibold mb-4 text-gray-100">Add New Payment</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="payment-date" class="block text-sm font-medium text-gray-300">Date</label>
                                <input type="date" id="payment-date" required class="mt-1 w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400">
                            </div>
                            <div>
                                <label for="payment-name" class="block text-sm font-medium text-gray-300">Name</label>
                                <select id="payment-name" required class="mt-1 w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white">
                                    <option value="">Select a person</option>
                                    <!-- Names populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="payment-amount" class="block text-sm font-medium text-gray-300">Amount (₹)</label>
                                <input type="number" id="payment-amount" step="0.01" min="0" required class="mt-1 w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400" placeholder="0.00">
                            </div>
                        </div>
                        <div class="mt-6 flex space-x-4">
                            <button type="submit" id="submit-payment-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-blue-700 transition duration-150">Add Payment</button>
                            <button type="button" id="cancel-edit-btn" class="hidden bg-gray-500 text-white px-6 py-2 rounded-lg shadow-md hover:bg-gray-600 transition duration-150">Cancel Edit</button>
                        </div>
                        <input type="hidden" id="payment-id-hidden">
                    </form>

                    <!-- All Payments Table -->
                    <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                        <h3 class="text-xl font-semibold text-gray-100 p-6">All Payments</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Name</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Amount</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="payments-table-body" class="bg-gray-800 divide-y divide-gray-700">
                                    <!-- Rows populated by JS -->
                                </tbody>
                            </table>
                        </div>
                        <p id="no-payments-msg" class="p-6 text-center text-gray-400 hidden">No payments recorded yet.</p>
                    </div>
                </section>

                <!-- Manage People Tab -->
                <section id="people-tab" class="tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Add/Edit Person Form -->
                    <form id="person-form" class="bg-gray-800 p-6 rounded-lg shadow-lg h-fit">
                        <h3 id="person-form-title" class="text-xl font-semibold mb-4 text-gray-100">Add New Person</h3>
                        <div class="flex space-x-4">
                            <input type="text" id="person-name" placeholder="Enter new name" required class="flex-1 px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400">
                            <button type="submit" id="submit-person-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-green-700 transition duration-150">Add</button>
                        </div>
                         <div class="mt-4">
                             <button type="button" id="cancel-person-edit-btn" class="hidden w-full bg-gray-500 text-white px-6 py-2 rounded-lg shadow-md hover:bg-gray-600 transition duration-150">Cancel Edit</button>
                        </div>
                        <input type="hidden" id="person-id-hidden">
                        <input type="hidden" id="person-old-name-hidden">
                    </form>

                    <!-- People List -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-gray-100">People List</h3>
                        <ul id="people-list" class="space-y-3">
                            <!-- List populated by JS -->
                        </ul>
                        <p id="no-people-msg" class="text-center text-gray-400 hidden">No people added yet.</p>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, query, where, setDoc, serverTimestamp, writeBatch, setLogLevel, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config (Hard-coded as requested) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJ9K9fQ0ThMB7aXB6qNHr3_yLUdqJgnCM",
            authDomain: "my-chain-reaction-game.firebaseapp.com",
            projectId: "my-chain-reaction-game",
            storageBucket: "my-chain-reaction-game.appspot.com",
            messagingSenderId: "32751418407",
            appId: "1:32751418407:web:ff8244007ef2b099d56202"
        };
        
        // --- App & Firebase Globals ---
        let app, auth, db;
        let userId = null;
        let unsubscribePayments = null;
        let unsubscribePeople = null;
        let paymentsCache = [];
        let peopleCache = [];
        let personsChartInstance = null;
        let monthlyChartInstance = null;
        
        // --- CRITICAL FIX ---
        // We MUST hard-code the appId to match the hard-coded firebaseConfig.
        // This ensures the database paths (e.g., /artifacts/my-chain-reaction-game/...)
        // are correct for the project we are connected to.
        const appId = 'my-chain-reaction-game';
        // --- END FIX ---
        
        // --- UI Element Globals ---
        // Auth
        const authSection = document.getElementById('auth-section');
        const appSection = document.getElementById('app-section');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailSpan = document.getElementById('user-email');
        const authError = document.getElementById('auth-error');
        const authLoading = document.getElementById('auth-loading');
        const configError = document.getElementById('config-error');

        // Tabs
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Payments
        const paymentForm = document.getElementById('payment-form');
        const formTitle = document.getElementById('form-title');
        const paymentDate = document.getElementById('payment-date');
        const paymentNameSelect = document.getElementById('payment-name');
        const paymentAmount = document.getElementById('payment-amount');
        const submitPaymentBtn = document.getElementById('submit-payment-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const paymentIdHidden = document.getElementById('payment-id-hidden');
        const paymentsTableBody = document.getElementById('payments-table-body');
        const noPaymentsMsg = document.getElementById('no-payments-msg');
        
        // People
        const personForm = document.getElementById('person-form');
        const personNameInput = document.getElementById('person-name');
        const peopleList = document.getElementById('people-list');
        const noPeopleMsg = document.getElementById('no-people-msg');
        const personFormTitle = document.getElementById('person-form-title');
        const submitPersonBtn = document.getElementById('submit-person-btn');
        const cancelPersonEditBtn = document.getElementById('cancel-person-edit-btn');
        const personIdHidden = document.getElementById('person-id-hidden');
        const personOldNameHidden = document.getElementById('person-old-name-hidden');
        
        // Dashboard
        const totalSpendingEl = document.getElementById('total-spending');
        const monthlyReportYearSelect = document.getElementById('monthly-report-year');
        
        // --- Chart Config ---
        // Predefined colors for the person chart
        const CHART_COLORS = [
            '#3b82f6', // blue-500
            '#10b981', // emerald-500
            '#ef4444', // red-500
            '#f97316', // orange-500
            '#a855f7', // purple-500
            '#eab308', // yellow-500
            '#ec4899', // pink-500
            '#6366f1', // indigo-500
            '#06b6d4', // cyan-500
            '#f43f5e', // rose-500
        ];
        
        // Set Chart.js defaults for dark mode
        Chart.defaults.color = '#e5e7eb'; // gray-200
        Chart.defaults.borderColor = '#4b5563'; // gray-600

        /**
         * Utility: Show toast message
         * @param {string} message - The message to display.
         * @param {boolean} [isError=false] - If true, show error colors.
         */
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('hidden');
            if (isError) {
                toast.classList.add('bg-red-600');
                toast.classList.remove('bg-green-600');
            } else {
                toast.classList.add('bg-green-600');
                toast.classList.remove('bg-red-600');
            }
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        /**
         * Utility: Format number as INR currency
         * @param {number} amount - The number to format.
         * @returns {string} - Formatted currency string (e.g., ₹1,234.50).
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
            }).format(amount);
        }

        // --- Firebase Initialization & Auth ---

        /**
         * Initializes the Firebase app and auth.
         */
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Enable Firestore logging
                console.log("Firebase initialized successfully.");
                setupAuthListener();
            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                configError.textContent = "Error: Failed to initialize app. Please check console.";
                configError.classList.remove('hidden');
                authLoading.classList.add('hidden');
            }
        }

        /**
         * Sets up the listener for auth state changes.
         */
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in
                    console.log("User is signed in:", user.uid);
                    userId = user.uid;
                    userEmailSpan.textContent = user.email;
                    userEmailSpan.classList.remove('hidden');
                    logoutBtn.classList.remove('hidden');
                    authSection.classList.add('hidden');
                    appSection.classList.remove('hidden');
                    
                    // Set default date for payment form
                    paymentDate.value = new Date().toISOString().split('T')[0];
                    
                    // Attach Firestore listeners
                    attachFirestoreListeners();
                    
                } else {
                    // User is signed out
                    console.log("User is signed out.");
                    userId = null;
                    userEmailSpan.textContent = '';
                    userEmailSpan.classList.add('hidden');
                    logoutBtn.classList.add('hidden');
                    authSection.classList.remove('hidden');
                    appSection.classList.add('hidden');
                    
                    // Detach listeners if they exist
                    if (unsubscribePayments) unsubscribePayments();
                    if (unsubscribePeople) unsubscribePeople();
                    
                    // Clear local caches
                    paymentsCache = [];
                    peopleCache = [];
                }
                authLoading.classList.add('hidden');
            });
        }

        /**
         * Handles user login.
         */
        async function handleLogin() {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                authError.textContent = "Please enter both email and password.";
                return;
            }
            authError.textContent = "";
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Auth listener will handle the rest
            } catch (error) {
                console.error("Login failed:", error.message);
                authError.textContent = `Login failed: ${error.message}`;
            }
        }

        /**
         * Handles user signup.
         */
        async function handleSignup() {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                authError.textContent = "Please enter both email and password.";
                return;
            }
            if (password.length < 6) {
                authError.textContent = "Password must be at least 6 characters.";
                return;
            }
            authError.textContent = "";

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // Auth listener will handle the rest
            } catch (error) {
                console.error("Signup failed:", error.message);
                authError.textContent = `Signup failed: ${error.message}`;
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
                // Auth listener will handle the rest
            } catch (error) {
                console.error("Logout failed:", error);
                showToast("Logout failed. Please try again.", true);
            }
        }

        // --- Tab Navigation ---

        /**
         * Handles tab switching.
         * @param {Event} e - The click event.
         */
        function handleTabClick(e) {
            const clickedTab = e.currentTarget;
            const tabName = clickedTab.dataset.tab;

            // Update button styles
            tabButtons.forEach(btn => btn.classList.remove('active'));
            clickedTab.classList.add('active');

            // Show/hide content
            tabContents.forEach(content => {
                if (content.id === `${tabName}-tab`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
            
            // Re-render charts if dashboard is clicked and data is ready
            if (tabName === 'dashboard' && paymentsCache.length > 0) {
                 updateCharts();
            }
        }

        // --- Firestore & Data Logic ---

        /**
         * Attaches real-time listeners for payments and people.
         */
        function attachFirestoreListeners() {
            if (!userId) return;
            
            // Detach old listeners if they exist
            if (unsubscribePayments) unsubscribePayments();
            if (unsubscribePeople) unsubscribePeople();

            // --- People Listener ---
            const peoplePath = `/artifacts/${appId}/users/${userId}/persons`;
            const peopleQuery = query(collection(db, peoplePath));
            
            unsubscribePeople = onSnapshot(peopleQuery, (snapshot) => {
                console.log("People listener updated.");
                peopleCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Sort by name
                peopleCache.sort((a, b) => a.name.localeCompare(b.name));
                
                renderPeopleList(peopleCache);
                updatePaymentNameSelect(peopleCache);
                
            }, (error) => {
                console.error("Error in people listener:", error);
                showToast("Error loading people data.", true);
            });

            // --- Payments Listener ---
            const paymentsPath = `/artifacts/${appId}/users/${userId}/payments`;
            const paymentsQuery = query(collection(db, paymentsPath));

            unsubscribePayments = onSnapshot(paymentsQuery, (snapshot) => {
                console.log("Payments listener updated.");
                paymentsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Sort by date, newest first
                paymentsCache.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                renderPaymentsTable(paymentsCache);
                updateDashboard(paymentsCache);
                
            }, (error) => {
                console.error("Error in payments listener:", error);
                showToast("Error loading payments data.", true);
            });
        }

        // --- People Management ---

        /**
         * Renders the list of people in the "Manage People" tab.
         * @param {Array} people - Array of person objects.
         */
        function renderPeopleList(people) {
            peopleList.innerHTML = ''; // Clear list
            
            if (people.length === 0) {
                noPeopleMsg.classList.remove('hidden');
            } else {
                noPeopleMsg.classList.add('hidden');
                people.forEach(person => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-3 bg-gray-700 rounded-lg';
                    li.innerHTML = `
                        <span class="text-gray-100">${person.name}</span>
                        <div class="flex space-x-2">
                            <button data-id="${person.id}" data-name="${person.name}" class="edit-person-btn text-blue-400 hover:text-blue-300">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                            <button data-id="${person.id}" data-name="${person.name}" class="delete-person-btn text-red-500 hover:text-red-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    peopleList.appendChild(li);
                });
            }
        }

        /**
         * Populates the <select> dropdown in the payment form.
         * @param {Array} people - Array of person objects.
         */
        function updatePaymentNameSelect(people) {
            const currentVal = paymentNameSelect.value;
            paymentNameSelect.innerHTML = '<option value="">Select a person</option>'; // Clear and add default
            
            people.forEach(person => {
                const option = document.createElement('option');
                option.value = person.name;
                option.textContent = person.name;
                paymentNameSelect.appendChild(option);
            });
            
            // Try to preserve selection if it still exists
            if (people.some(p => p.name === currentVal)) {
                paymentNameSelect.value = currentVal;
            }
        }
        
        /**
         * Handles the submission of the "Add Person" form.
         * @param {Event} e - The form submit event.
         */
        async function handleSubmitPerson(e) {
            e.preventDefault();
            const newName = personNameInput.value.trim();
            if (!newName) return;

            const personId = personIdHidden.value;
            const oldName = personOldNameHidden.value;
            
            // Check for duplicates (case-insensitive)
            const existingPerson = peopleCache.find(p => p.name.toLowerCase() === newName.toLowerCase());
            
            // Check if in edit mode
            if (personId) {
                // In edit mode
                if (existingPerson && existingPerson.id !== personId) {
                     showToast("This name is already used by another person.", true);
                     return;
                }
                
                // --- Atomic update ---
                // Update the person doc AND all payment docs that used the old name
                try {
                    const batch = writeBatch(db);
                    
                    // 1. Update the person document
                    const personDocPath = `/artifacts/${appId}/users/${userId}/persons/${personId}`;
                    batch.update(doc(db, personDocPath), { name: newName });
                    
                    // 2. Find and update all associated payments
                    const paymentsPath = `/artifacts/${appId}/users/${userId}/payments`;
                    const paymentsQuery = query(collection(db, paymentsPath), where("name", "==", oldName));
                    
                    const querySnapshot = await getDocs(paymentsQuery);
                    querySnapshot.forEach((paymentDoc) => {
                        // Update the 'name' field on each payment
                        batch.update(paymentDoc.ref, { name: newName });
                    });
                    
                    // 3. Commit the batch
                    await batch.commit();
                    
                    showToast("Person and all associated payments updated!");
                    resetPersonForm();
                    
                } catch (error) {
                    console.error("Error updating person and payments:", error);
                    showToast("Failed to update person.", true);
                }
                
            } else {
                // In add mode
                if (existingPerson) {
                    showToast("This person already exists.", true);
                    return;
                }

                try {
                    const personsPath = `/artifacts/${appId}/users/${userId}/persons`;
                    const personsRef = collection(db, personsPath);
                    await addDoc(personsRef, {
                        name: newName,
                        createdAt: serverTimestamp()
                    });
                    
                    personNameInput.value = '';
                    showToast("Person added successfully!");
                    
                } catch (error) {
                    console.error("Error adding person:", error);
                    showToast("Failed to add person.", true);
                }
            }
        }

        /**
         * Populates the person form for editing.
         * @param {string} personId - The Firestore document ID of the person.
         * @param {string} personName - The current name of the person.
         */
        function handleEditPerson(personId, personName) {
            personNameInput.value = personName;
            personIdHidden.value = personId;
            personOldNameHidden.value = personName;
            
            personFormTitle.textContent = "Edit Person's Name";
            submitPersonBtn.textContent = "Update Name";
            cancelPersonEditBtn.classList.remove('hidden');
            
            personForm.scrollIntoView({ behavior: 'smooth' });
            personNameInput.focus();
        }

        /**
         * Resets the person form to its default (add) state.
         */
        function resetPersonForm() {
            personForm.reset();
            personIdHidden.value = '';
            personOldNameHidden.value = '';
            personFormTitle.textContent = 'Add New Person';
            submitPersonBtn.textContent = 'Add';
            cancelPersonEditBtn.classList.add('hidden');
        }

        /**
         * Handles deleting a person.
         * @param {string} personId - The Firestore document ID of the person.
         * @param {string} personName - The name of the person.
         */
        async function handleDeletePerson(personId, personName) {
            // Check if this person has any payments
            const hasPayments = paymentsCache.some(p => p.name === personName);
            
            if (hasPayments) {
                showToast("Cannot delete person. They are associated with payments. Please delete or re-assign their payments first.", true);
                return;
            }
            
            // If no payments, safe to delete
            try {
                const personPath = `/artifacts/${appId}/users/${userId}/persons/${personId}`;
                await deleteDoc(doc(db, personPath));
                showToast("Person deleted.");
                resetPersonForm(); // In case we were editing this one
                
            } catch (error) {
                console.error("Error deleting person:", error);
                showToast("Failed to delete person.", true);
            }
        }

        // --- Payment Management ---

        /**
         * Renders the payments table.
         * @param {Array} payments - Array of payment objects.
         */
        function renderPaymentsTable(payments) {
            paymentsTableBody.innerHTML = ''; // Clear table
            
            if (payments.length === 0) {
                noPaymentsMsg.classList.remove('hidden');
            } else {
                noPaymentsMsg.classList.add('hidden');
                payments.forEach(payment => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-700";
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-100">${payment.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-100">${payment.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-100">${formatCurrency(payment.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right space-x-2">
                            <button data-id="${payment.id}" class="edit-payment-btn text-blue-400 hover:text-blue-300">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                            <button data-id="${payment.id}" class="delete-payment-btn text-red-500 hover:text-red-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </td>
                    `;
                    paymentsTableBody.appendChild(tr);
                });
            }
        }

        /**
         * Handles submission of the Add/Edit Payment form.
         * @param {Event} e - The form submit event.
         */
        async function handleSubmitPayment(e) {
            e.preventDefault();
            
            const paymentData = {
                date: paymentDate.value,
                name: paymentNameSelect.value,
                amount: parseFloat(paymentAmount.value),
            };
            
            if (!paymentData.date || !paymentData.name || isNaN(paymentData.amount) || paymentData.amount <= 0) {
                showToast("Please fill in all fields with valid data.", true);
                return;
            }
            
            const paymentId = paymentIdHidden.value;
            
            try {
                if (paymentId) {
                    // Update existing payment
                    const paymentPath = `/artifacts/${appId}/users/${userId}/payments/${paymentId}`;
                    await updateDoc(doc(db, paymentPath), paymentData);
                    showToast("Payment updated!");
                } else {
                    // Add new payment
                    const paymentsPath = `/artifacts/${appId}/users/${userId}/payments`;
                    await addDoc(collection(db, paymentsPath), {
                        ...paymentData,
                        createdAt: serverTimestamp()
                    });
                    showToast("Payment added!");
                }
                resetPaymentForm();
                
            } catch (error) {
                console.error("Error saving payment:", error);
                showToast("Failed to save payment.", true);
            }
        }
        
        /**
         * Resets the payment form to its default (add) state.
         */
        function resetPaymentForm() {
            paymentForm.reset();
            paymentIdHidden.value = '';
            paymentDate.value = new Date().toISOString().split('T')[0]; // Reset date to today
            formTitle.textContent = "Add New Payment";
            submitPaymentBtn.textContent = "Add Payment";
            cancelEditBtn.classList.add('hidden');
        }

        /**
         * Populates the payment form for editing.
         * @param {string} paymentId - The Firestore document ID of the payment.
         */
        function handleEditPayment(paymentId) {
            // Find the payment in our local cache
            const payment = paymentsCache.find(p => p.id === paymentId);
            if (!payment) {
                showToast("Could not find payment to edit.", true);
                return;
            }
            
            // Populate the form
            paymentDate.value = payment.date;
            paymentNameSelect.value = payment.name;
            paymentAmount.value = payment.amount;
            paymentIdHidden.value = paymentId;
            
            // Update UI to "edit mode"
            formTitle.textContent = "Edit Payment";
            submitPaymentBtn.textContent = "Update Payment";
            cancelEditBtn.classList.remove('hidden');
            
            // Scroll to the form
            paymentForm.scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * Handles deleting a payment.
         * @param {string} paymentId - The Firestore document ID of the payment.
        */
        async function handleDeletePayment(paymentId) {
            try {
                const paymentPath = `/artifacts/${appId}/users/${userId}/payments/${paymentId}`;
                await deleteDoc(doc(db, paymentPath));
                showToast("Payment deleted.");
                resetPaymentForm(); // In case we were editing this one
                
            } catch (error) {
                console.error("Error deleting payment:", error);
                showToast("Failed to delete payment.", true);
            }
        }
        
        // --- Dashboard & Charts ---

        /**
         * Updates all dashboard elements.
         * @param {Array} payments - Array of payment objects.
         */
        function updateDashboard(payments) {
            // 1. Calculate and render total spending
            const totalSpending = payments.reduce((sum, p) => sum + p.amount, 0);
            totalSpendingEl.textContent = formatCurrency(totalSpending);
            
            // 2. Populate year select for monthly report
            populateYearSelect(payments);
            
            // 3. Update charts
            updateCharts();
        }

        /**
         * Triggers re-render of both charts.
         */
         function updateCharts() {
            renderPersonsChart();
            renderMonthlyChart();
         }
        
        /**
         * Calculates and renders the "Spending by Person" chart.
         */
        function renderPersonsChart() {
            const ctx = document.getElementById('persons-chart').getContext('2d');
            
            // Aggregate spending by person
            const spending = paymentsCache.reduce((acc, payment) => {
                acc[payment.name] = (acc[payment.name] || 0) + payment.amount;
                return acc;
            }, {});

            const labels = Object.keys(spending);
            const data = Object.values(spending);
            
            // --- NEW: Generate dynamic colors ---
            const backgroundColors = labels.map((_, i) => CHART_COLORS[i % CHART_COLORS.length] + 'B3'); // with 70% opacity
            const borderColors = labels.map((_, i) => CHART_COLORS[i % CHART_COLORS.length]);

            if (personsChartInstance) {
                personsChartInstance.destroy();
            }
            
            if (labels.length === 0) {
                // Don't render an empty chart
                return;
            }

            personsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Spending',
                        data: data,
                        backgroundColor: backgroundColors, // Use dynamic colors
                        borderColor: borderColors,     // Use dynamic colors
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // Hide legend since colors are self-explanatory
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {}
                    }
                }
            });
        }
        
        /**
         * Populates the year dropdown for the monthly chart.
         * @param {Array} payments - Array of payment objects.
         */
        function populateYearSelect(payments) {
            if (payments.length === 0) return;
            
            const years = [...new Set(payments.map(p => new Date(p.date).getFullYear()))];
            years.sort((a, b) => b - a); // Newest first
            
            const currentVal = monthlyReportYearSelect.value;
            monthlyReportYearSelect.innerHTML = ''; // Clear
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                monthlyReportYearSelect.appendChild(option);
            });
            
            // Restore selection or default to newest
            if (years.includes(parseInt(currentVal))) {
                monthlyReportYearSelect.value = currentVal;
            } else {
                monthlyReportYearSelect.value = years[0];
            }
        }

        /**
         * Calculates and renders the "Monthly Report" line chart.
         */
        function renderMonthlyChart() {
            const ctx = document.getElementById('monthly-chart').getContext('2d');
            const selectedYear = parseInt(monthlyReportYearSelect.value);

            if (isNaN(selectedYear)) {
                // No data or year not selected yet
                if (monthlyChartInstance) monthlyChartInstance.destroy();
                return;
            }
            
            // Initialize 12 months with 0
            const monthlyTotals = new Array(12).fill(0);
            
            // Filter payments for the selected year
            const paymentsForYear = paymentsCache.filter(p => new Date(p.date).getFullYear() === selectedYear);
            
            // Aggregate spending by month
            paymentsForYear.forEach(payment => {
                const month = new Date(payment.date).getMonth(); // 0 = Jan, 11 = Dec
                monthlyTotals[month] += payment.amount;
            });
            
            const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const data = monthlyTotals;
            
            if (monthlyChartInstance) {
                monthlyChartInstance.destroy();
            }

            monthlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Spending in ${selectedYear}`,
                        data: data,
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)', // blue-500 with opacity
                        borderColor: 'rgba(59, 130, 246, 1)',     // blue-500
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                           display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // --- Event Listeners ---
        
        window.onload = initializeFirebase;
        
        // --- Auth Listeners ---
        loginBtn.addEventListener('click', handleLogin);
        signupBtn.addEventListener('click', handleSignup);
        logoutBtn.addEventListener('click', handleLogout);

        // --- Tab Listeners ---
        tabButtons.forEach(btn => btn.addEventListener('click', handleTabClick));

        // --- Form Listeners ---
        personForm.addEventListener('submit', handleSubmitPerson);
        cancelPersonEditBtn.addEventListener('click', resetPersonForm);
        paymentForm.addEventListener('submit', handleSubmitPayment);
        cancelEditBtn.addEventListener('click', resetPaymentForm);
        monthlyReportYearSelect.addEventListener('change', renderMonthlyChart);

        // --- Dynamic Table/List Listeners (Event Delegation) ---
        
        // Listener for "People" list
        peopleList.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-person-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                const name = deleteBtn.dataset.name;
                handleDeletePerson(id, name);
                return; // Prevent edit from firing
            }
            
            const editBtn = e.target.closest('.edit-person-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                const name = editBtn.dataset.name; // Fixed: removed extra dot from 'dataset..name'
                handleEditPerson(id, name);
            }
        });
        
        // Listener for "Payments" table
        paymentsTableBody.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-payment-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                handleDeletePayment(id);
                return;
            }

            const editBtn = e.target.closest('.edit-payment-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                handleEditPayment(id);
            }
        });

    </script>
</body>
</html>
